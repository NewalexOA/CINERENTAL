# План реализации функциональности проектных бронирований

## 1. Общая дорожная карта

| Спринт | Продолжительность | Статус | Прогресс |
|--------|-------------------|----------|----------|
| Спринт 1: Механизм сессий сканирования | 2 недели | ✅ Завершено | 100% |
| Спринт 2: Модификация интерфейса сканера | 1.5 недели | ✅ Завершено | 100% |
| Спринт 3: Интерфейс для работы с проектами | 2 недели | ✅ Завершено | 100% |
| Спринт 4: Тестирование и оптимизация | 1.5 недели | ⏳ В процессе | 80% |

## 2. Детальный план с отметками о выполнении

### 2.1. Модель ScanSession и серверная часть

```python
class ScanSession(TimestampMixin, Base):
    """Scan session model for temporary storage of scanned equipment.

    Attributes:
        id: Primary key
        user_id: Reference to user (optional)
        name: Session name
        items: JSON array of scanned items
        expires_at: Expiration date
    """

    __tablename__ = 'equipment_scan_sessions'

    id: Mapped[int] = mapped_column(primary_key=True)
    user_id: Mapped[Optional[int]] = mapped_column(
        ForeignKey('users.id', ondelete='CASCADE'),
        nullable=True,
        index=True,
    )
    name: Mapped[str] = mapped_column(String(255), nullable=False)
    items: Mapped[dict] = mapped_column(JSON, nullable=False, default=list)
    expires_at: Mapped[datetime] = mapped_column(
        DateTime(timezone=True), nullable=False
    )
```

- [x] Создание модели данных `ScanSession`
- [x] Добавление миграции базы данных
- [x] Разработка репозитория `ScanSessionRepository`
- [x] Разработка сервиса `ScanSessionService`
- [x] Реализация API эндпоинтов:
  - [x] POST /api/v1/scan-sessions
  - [x] GET /api/v1/scan-sessions/{id}
  - [x] PUT /api/v1/scan-sessions/{id}
  - [x] DELETE /api/v1/scan-sessions/{id}
  - [x] GET /api/v1/scan-sessions/user/{user_id}
- [x] Реализация механизма очистки устаревших сессий

### 2.2. Клиентская часть для работы с временным списком

```typescript
// Интерфейс для сессии сканирования
interface ScanSession {
  id: string;             // Локальный ID сессии
  name: string;           // Название сессии
  items: Equipment[];     // Массив отсканированного оборудования
  updatedAt: string;      // Дата последнего обновления
  syncedWithServer: boolean;  // Флаг синхронизации с сервером
  serverSessionId?: number;   // ID сессии на сервере (если синхронизировано)
}

// Методы для работы с localStorage
const scanStorage = {
  // Получение всех сессий
  getSessions(): ScanSession[] { ... },

  // Получение конкретной сессии
  getSession(id: string): ScanSession | undefined { ... },

  // Создание новой сессии
  createSession(name: string): ScanSession { ... },

  // Добавление оборудования в сессию
  addEquipment(sessionId: string, equipment: Equipment): ScanSession | undefined { ... },

  // Удаление оборудования из сессии
  removeEquipment(sessionId: string, equipmentId: number): ScanSession | undefined { ... },

  // Удаление сессии
  deleteSession(sessionId: string): boolean { ... },

  // Обновление статуса синхронизации
  updateServerSync(sessionId: string, serverSessionId: number): ScanSession | undefined { ... },
}
```

- [x] Разработка утилиты для работы с localStorage (scanStorage)
- [x] Сервис для работы с API сессий
- [x] Компонент синхронизации

### 2.3. Модификация интерфейса сканера

#### Задачи по модификации сканера

- [x] Обновление компонента сканера
- [x] Добавление функциональности для сохранения отсканированных позиций
- [x] Реализация отображения списка отсканированного оборудования
- [x] Добавление возможности удаления позиций из списка
- [x] Настройка маршрутизации
- [x] Добавление новых маршрутов для работы с проектами
- [x] Изменение навигации после сканирования
- [x] Тестирование (юнит- и интеграционное)

### 2.4. Интерфейс для работы с проектами

#### Страница выбора проекта

- [x] Разработка компонента выбора проекта
- [x] Создание интерфейса для выбора существующего проекта
- [x] Добавление возможности создания нового проекта
- [x] Интеграция с временным списком оборудования
- [x] Форма создания проекта
- [x] Разработка формы с необходимыми полями
- [x] Валидация ввода
- [x] Интеграция с API

#### Страница проекта и массовое создание бронирований

- [x] Страница детального просмотра проекта
  - [x] Отображение информации о проекте
  - [x] Список связанных бронирований
  - [x] Функции управления проектом
- [x] Массовое создание бронирований с индивидуальными датами
- [x] Проверка доступности оборудования на выбранные даты
- [x] Пакетное создание бронирований
- [x] Оптимизация пользовательского опыта
  - [x] Добавление индикаторов загрузки
  - [x] Обработка ошибок
  - [x] Улучшение навигации между экранами

### 2.5. Тестирование и оптимизация

- [x] Юнит-тесты для всех компонентов
  _Покрытие по всем ключевым сервисам, тесты в tests/unit._
- [x] Интеграционные тесты для проверки взаимодействия компонентов
  _Покрытие бизнес-процессов, API, ошибок, статусов, tests/integration._
- [~] E2E-тесты для основных пользовательских сценариев
  _Есть базовые e2e-тесты, но не полный набор пользовательских потоков._
- [~] Оптимизация производительности
  _Оптимизация запросов и API есть, но нагрузочные тесты и профилирование в процессе._
- [~] Исправление выявленных ошибок (по мере необходимости)
  _Исправления багов и тесты на ошибки присутствуют, требует постоянного контроля._

## 3. Первоочередные задачи для завершения

### 3.1. Исправление ошибки в модуле сканирования (Приоритет: Высокий)

- [x] Проанализировать текущую реализацию сканера оборудования
- [x] Разработать механизм `scanStorage` для хранения временных данных
  - [x] Создать интерфейс для работы с localStorage
  - [x] Реализовать методы сохранения и извлечения данных сессии
  - [x] Добавить валидацию и обработку ошибок
- [x] Интегрировать scanStorage в компонент сканера
- [x] Обновить механизм загрузки данных сессии на странице создания проекта
- [x] Протестировать работоспособность всех компонентов

### 3.2. Доработка страницы создания проекта (Приоритет: Высокий)

- [x] Завершить интерфейс страницы frontend/templates/projects/new.html
- [x] Разработать компонент для отображения списка отсканированного оборудования
  - [x] Добавить возможность удаления позиций из списка
  - [x] Реализовать вывод информации о каждой единице оборудования
- [x] Создать форму для ввода основных данных проекта
  - [x] Название проекта
  - [~] Выбор клиента (с поиском)
  - [x] Период проекта (общие даты начала и окончания)
  - [x] Описание и примечания
- [x] Реализовать сохранение проекта и связанных бронирований
  - [x] Обновить API эндпоинты для массового создания бронирований
  - [x] Добавить валидацию данных на фронтенде

### 3.3. Компонент массового добавления оборудования (Приоритет: Средний)

- [x] Разработать интерфейс для назначения индивидуальных дат бронирования
  - [x] Создать календарный компонент для выбора дат
  - [x] Реализовать возможность массового изменения дат для группы оборудования
- [x] Интегрировать проверку доступности оборудования в режиме реального времени
  - [x] Создать API для проверки доступности по заданному периоду
  - [x] Визуализировать конфликты и недоступные даты
- [ ] Разработать механизм автоматического распределения дат на основе общего периода проекта
- [x] Обновить серверную часть для поддержки массовых операций с бронированиями

## 4. Оценка ресурсов и рисков

### 4.1. Необходимые ресурсы

- Backend-разработчик: 3 человеко-недели
- Frontend-разработчик: 4 человеко-недели
- QA-инженер: 2 человеко-недели
- Product Manager: 1 человеко-неделя

### 4.2. Зависимости

- Доступ к API существующей системы
- Документация по текущему функционалу сканера
- Тестовая среда с актуальными данными

### 4.3. Потенциальные риски

- Сложности при интеграции с существующим функционалом сканера
- Проблемы с синхронизацией данных между устройствами
- Ограниченное пространство localStorage в браузерах

### 4.4. Стратегии снижения рисков

- Раннее тестирование интеграции с существующими компонентами
- Разработка механизма резервного копирования данных для предотвращения потери информации
- Оптимизация структуры данных для минимизации объема хранимой информации в localStorage

## 5. Критерии завершения

### 5.1. Функциональные критерии

- Возможность сохранения отсканированного оборудования во временный список
- Успешная синхронизация данных между устройствами
- Возможность выбора существующего проекта или создания нового
- Возможность задания индивидуальных дат бронирования для каждой единицы оборудования
- Массовое создание бронирований в рамках одного проекта

### 5.2. Технические критерии

- Покрытие нового кода юнит-тестами не менее 80%
- Среднее время ответа API не более 300 мс
- Отсутствие критических ошибок в журнале
- Совместимость с последними версиями браузеров (Chrome, Firefox, Safari)

### 5.3. Пользовательские критерии

- Удобство использования интерфейса (подтверждено тестированием)
- Корректная работа на мобильных устройствах
- Устойчивость к ошибкам пользователя

## 6. График реализации

1. **Фаза 1 (Неделя 1-2)**: Исправление ошибки в модуле сканирования и завершение ScanSession API
2. **Фаза 2 (Неделя 3-4)**: Доработка страницы создания проекта и интеграция сканера
3. **Фаза 3 (Неделя 5-6)**: Компонент массового добавления оборудования и функции проверки доступности
4. **Фаза 4 (Неделя 7-8)**: Тестирование и оптимизация

---
**Здесь содержится актуальный статус выполнения, прогресс по задачам и приоритеты для всей проектной функциональности.**
