# Техническое задание на систему управления арендой кинооборудования

## 1. Описание системы

Система предназначена для управления арендой кинооборудования. Она позволит менеджерам контролировать доступность и бронирование оборудования, управлять состоянием заказов и следить за состоянием возврата оборудования. Клиенты не имеют доступа к программе и не могут выбирать оборудование для бронирования.

## 2. Основные сущности

- **Оборудование**: Каждое оборудование (камеры, объективы, аксессуары) будет хранить характеристики: название, штрих-код (или QR-код), серийный номер, состояние ("AVAILABLE" - Доступно, "RENTED" - В аренде, "MAINTENANCE" - В ремонте, "BROKEN" - Неисправно, "RETIRED" - Списано). Дефолтный статус: "AVAILABLE". Стоимость замены (для расчета страховки и залога). Оборудование организовано в иерархическую систему категорий и подкатегорий.
- **Категории оборудования**: Древовидная структура категорий с возможностью создания неограниченного количества уровней вложенности. Управление категориями доступно через интерфейс системы.
- **Клиенты**: Клиенты не имеют доступа к программе. Информация о клиенте будет храниться для назначения аренды. Система хранит полную историю аренд для каждого клиента.
- **Бронирования**: Менеджер подбирает оборудование для аренды и устанавливает дату начала и окончания аренды. Каждое бронирование может включать несколько единиц оборудования или количество для оборудования без серийного номера.
- **Проекты**: Группировка нескольких бронирований в единый проект/заказ. Проект может содержать бронирования с разными датами аренды для отдельного оборудования.

- **Сессии сканирования**: Временное хранение результатов сканирования для массовых операций возврата и выдачи оборудования.

## 3. Механизм бронирования

- Менеджер подбирает комплект оборудования (по одному или нескольким единицам), указывает контактные данные клиента и выбирает даты аренды.
- Для каждого оборудования создается запись о бронировании, где указываются даты начала и окончания бронирования.
- Проверка доступности: система проверяет, нет ли пересечений с другими бронированиями на выбранные даты для каждого оборудования.
- Статус бронирования может быть "PENDING" (Ожидает), "CONFIRMED" (Подтверждено), "ACTIVE" (Активно), "COMPLETED" (Завершено), "CANCELLED" (Отменено) или "OVERDUE" (Просрочено). "Активное" оборудование будет "занято" на выбранные даты и не доступно для повторного бронирования в этот период.
- Статус оплаты отдельно отслеживается: "PENDING" (Ожидание), "PARTIAL" (Частично), "PAID" (Оплачено), "REFUNDED" (Возвращено), "OVERDUE" (Просрочено).
- После бронирования оборудование блокируется на указанные даты, но в дальнейшем можно изменять или отменять бронирование.
- Система поддерживает создание проектов с множественными бронированиями и разными датами для отдельного оборудования.

## 4. Система возврата оборудования

- Менеджер использует сессии сканирования для массовой обработки возвращаемого оборудования.
- Система поддерживает временное хранение отсканированного оборудования с синхронизацией между браузером и сервером.
- Поддерживается частичный возврат оборудования: единицы оборудования из одного заказа могут быть возвращены в разное время.
- Система отслеживает статус возврата для каждой единицы оборудования в заказе.
- Заказ считается полностью завершённым только после возврата всех единиц оборудования.
- Для оборудования без серийного номера система отслеживает количество через увеличение/уменьшение счетчика.

## 5. Интерфейс и функционал для менеджера

- Менеджеры имеют доступ к полному функционалу.
- Интерфейс с возможностью управления бронированиями, выдачей оборудования, созданием и редактированием заказов.
- Сканирование штрих-кодов осуществляется через специальный сканер, работающий в режиме HID (эмуляция клавиатуры).
- Время отклика при сканировании и поиске оборудования в базе данных не должно превышать 1 секунды.
- Система генерации и печати штрих-кодов для нового оборудования.
- Создание печатных форм проектов с группировкой по категориям.
- Создание отчётов не требуется для MVP, будет реализовано позже.

## 6. Технологический стек

- **Backend**: Python FastAPI 0.115.6
- **Frontend**: Bootstrap для интерфейса с JavaScript модулями
- **База данных**:
  - PostgreSQL для хранения данных
  - Redis для кеширования и ускорения работы с частыми запросами
  - SQLAlchemy 2.0.25 для ORM
  - Alembic для миграций базы данных
  - Оптимизация для работы с объемом до 10 000 записей
  - Индексация полей для быстрого поиска по штрих-кодам
- **Докеризация**: Приложение будет работать локально в Docker-контейнере.

## 7. Данные в базе

- **Категории оборудования**:
  - ID категории
  - Название категории
  - ID родительской категории (null для корневых категорий)
  - Описание категории
  - Флаг показа в печатных формах
  - Временные метки (created_at, updated_at, deleted_at для soft delete)

- **Оборудование**:
  - ID, название, штрих-код, серийный номер, состояние
  - ID категории (связь с таблицей категорий)
  - Стоимость замены (целое число, для расчета страховки)
  - Внутренние заметки
  - Временные метки (created_at, updated_at, deleted_at для soft delete)

- **Клиенты**:
  - Обязательные поля:
    - ФИО
  - Дополнительные поля:
    - Контактный телефон
    - Email
    - Название компании
    - Внутренние заметки
  - Статус клиента ("ACTIVE" - Активный, "BLOCKED" - Заблокированный, "ARCHIVED" - Архивный). Дефолтный статус: "ACTIVE"
  - История аренд:
    - Связь с таблицей бронирований
    - Возможность просмотра всех прошлых заказов
  - Временные метки (created_at, updated_at, deleted_at для soft delete)

- **Проекты**:
  - ID, название, описание
  - ID клиента (связь с таблицей клиентов)
  - Даты начала и окончания проекта
  - Статус проекта ("DRAFT" - Черновик, "ACTIVE" - Активный, "COMPLETED" - Завершенный, "CANCELLED" - Отмененный). Дефолтный статус: "DRAFT"
  - Внутренние заметки
  - Временные метки (created_at, updated_at, deleted_at для soft delete)

- **Бронирования**:
  - ID оборудования, ID клиента, дата начала и окончания аренды
  - ID проекта (опционально, связь с таблицей проектов)
  - Количество единиц оборудования в бронировании
  - Статус бронирования ("PENDING" - Ожидает, "CONFIRMED" - Подтверждено, "ACTIVE" - Активно, "COMPLETED" - Завершено, "CANCELLED" - Отменено, "OVERDUE" - Просрочено). Дефолтный статус: "ACTIVE"
  - Статус оплаты ("PENDING" - Ожидание, "PARTIAL" - Частично, "PAID" - Оплачено, "REFUNDED" - Возвращено, "OVERDUE" - Просрочено). Дефолтный статус: "PENDING"
  - Общая стоимость заказа, размер залога, оплаченная сумма
  - Внутренние заметки
  - Временные метки (created_at, updated_at, deleted_at для soft delete)

- **Сессии сканирования**:
  - ID сессии, название сессии
  - ID пользователя (опционально)
  - JSON массив отсканированного оборудования
  - Дата истечения сессии (автоматическое удаление через 7 дней)
  - Временные метки (created_at, updated_at)

- **Генерация штрих-кодов**:
  - Глобальная последовательность для генерации уникальных штрих-кодов
  - Формат штрих-кода: NNNNNNNNNCC (9 цифр + 2-значная контрольная сумма)

## 8. Ценообразование

Система использует стоимость замены оборудования для расчета арендной платы:

- Арендная плата рассчитывается как 1% от стоимости замены за сутки
- Формула: `стоимость_замены * 0.01 * количество_дней * количество_единиц`
- Стоимость замены хранится как целое число (Integer) в рублях
- Максимальное значение стоимости замены: 100,000,000 рублей
- Залог рассчитывается индивидуально для каждого бронирования

## 9. План на будущее

- Внедрение автоматической отправки уведомлений (email, Telegram, SMS).
- Генерация документов для выдачи и приёма оборудования.
- Расширенные отчёты для анализа загрузки оборудования и финансов.
- Система скидок для постоянных клиентов
- Внедрение системы аутентификации и авторизации:
  - Разделение прав доступа (администраторы и менеджеры)
  - Аудит действий пользователей
  - Безопасное хранение учетных данных
  - Двухфакторная аутентификация
