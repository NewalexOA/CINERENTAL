# Руководство по развертыванию

## Конфигурация окружения

Проект использует файлы окружения для разных сценариев использования:

### Структура файлов окружения

1. **Файлы в репозитории** (версионируются):
   - `.env.example` - шаблон для разработки
     * Базовые настройки для локальной разработки
     * Безопасные значения по умолчанию
     * Используется как основа для создания `.env`

   - `.env.test` - настройки для тестирования
     * Конфигурация для тестового окружения
     * Использует отдельную тестовую базу данных
     * Применяется автоматически при запуске тестов

   - `.env.production` - шаблон для продакшена
     * Оптимизированные настройки
     * Повышенная безопасность
     * Заготовки для реальных учетных данных

2. **Локальные файлы** (не версионируются):
   - `.env` - основной файл с локальными настройками
     * Создается из `.env.example`
     * Содержит реальные учетные данные
     * Используется для разработки

   - `.env.local` (опционально) - персональные переопределения
     * Дополнительные настройки разработчика
     * Имеет приоритет над `.env`
     * Используется для специфичных локальных настроек

> ⚠️ **Важно**:
> 1. Файлы `.env` и `.env.local` содержат чувствительные данные и НИКОГДА не должны попадать в репозиторий
> 2. Убедитесь, что они добавлены в `.gitignore`
> 3. Всегда используйте шаблоны (`.env.example`, `.env.test`, `.env.production`) как основу

## Запуск приложения

### Режим разработки

1. Первоначальная настройка:
```bash
# Копируем шаблон окружения
cp .env.example .env

# Редактируем под свои нужды
nano .env
```

2. Запуск с автоперезагрузкой:
```bash
# Запуск с отслеживанием изменений
docker compose up --watch

# или просто
docker compose up
```

Особенности режима разработки:
- Автоматическая перезагрузка при изменении кода
- Подробное логирование
- Монтирование локальных файлов
- Загрузка тестовых данных
- Один воркер для удобства отладки

### Запуск тестов

```bash
# Запуск всех тестов
docker compose run --rm test

# Запуск конкретного теста
docker compose run --rm test ./docker/run-tests.sh tests/unit/test_equipment_service.py

# Запуск с дополнительными опциями (например, verbose)
docker compose run --rm test ./docker/run-tests.sh -v
```

Особенности тестового окружения:
- Использует отдельную тестовую базу данных
- Автоматически применяет `.env.test`
- Генерирует отчет о покрытии кода
- Изолированное окружение для каждого запуска

### Продакшен режим

1. Подготовка:
```bash
# Создаем файл окружения из шаблона
cp .env.production .env

# Настраиваем реальные параметры
nano .env
```

2. Запуск:
```bash
# Запуск только с базовым файлом конфигурации
docker compose -f docker-compose.yml up -d

# Просмотр логов
docker compose logs -f

# Остановка
docker compose down
```

Особенности продакшен режима:
- Оптимизированные настройки производительности
- Несколько воркеров
- Минимальное логирование
- Усиленная безопасность
- Отсутствие отладочных функций

## Дополнительные команды

### Управление контейнерами

```bash
# Пересборка при изменении зависимостей
docker compose build

# Просмотр статуса контейнеров
docker compose ps

# Просмотр логов конкретного сервиса
docker compose logs -f web
```

### Работа с базой данных

```bash
# Применение миграций
docker compose exec web alembic upgrade head

# Создание новой миграции
docker compose exec web alembic revision -m "description"
```

### Тестовые данные

```bash
# Загрузка тестовых данных (только в dev режиме)
docker compose exec web python -m backend.scripts.seed_data
```

## Переменные окружения

Основные группы настроек:

1. **Application settings**
   - `APP_NAME` - название приложения
   - `ENVIRONMENT` - окружение (development/test/production)
   - `DEBUG` - режим отладки
   - `SECRET_KEY` - секретный ключ приложения

2. **Server settings**
   - `ALLOWED_HOSTS` - разрешенные хосты
   - `WORKERS_COUNT` - количество воркеров
   - `LOG_LEVEL` - уровень логирования

3. **Database settings**
   - `POSTGRES_*` - настройки PostgreSQL

4. **Redis settings**
   - `REDIS_*` - настройки Redis

5. **Security settings**
   - `ACCESS_TOKEN_EXPIRE_MINUTES` - время жизни токена
   - `ALGORITHM` - алгоритм шифрования
   - `CORS_ORIGINS` - разрешенные источники CORS

6. **Storage settings**
   - `UPLOAD_DIR` - директория для загрузок
   - `MAX_UPLOAD_SIZE` - максимальный размер файла

7. **JWT settings**
   - `JWT_*` - настройки JWT аутентификации
