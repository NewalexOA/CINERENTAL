# Индексы и оптимизации базы данных CINERENTAL

## Общие принципы
- Все первичные ключи используют тип UUID для обеспечения уникальности и распределенной генерации
- Все таблицы имеют timestamps (created_at, updated_at) для аудита и отслеживания изменений
- Все внешние ключи индексируются для оптимизации JOIN операций
- Используются составные индексы для оптимизации частых запросов

## Индексы по таблицам

### Categories
1. **PRIMARY KEY** на `id`
2. **INDEX** на `parent_id` для оптимизации иерархических запросов
3. **INDEX** на `name` для поиска по названию категории
4. **INDEX** на `created_at` для сортировки и фильтрации по дате создания

### Equipment
1. **PRIMARY KEY** на `id`
2. **INDEX** на `category_id` для связи с категориями
3. **UNIQUE INDEX** на `barcode` для уникальности штрих-кодов
4. **INDEX** на `status` для фильтрации по статусу
5. **COMPOSITE INDEX** на `(status, category_id)` для фильтрации доступного оборудования по категориям
6. **INDEX** на `daily_price` для сортировки по цене
7. **INDEX** на `created_at` для сортировки и фильтрации по дате создания

### Clients
1. **PRIMARY KEY** на `id`
2. **UNIQUE INDEX** на `email` для уникальности email адресов
3. **INDEX** на `phone` для поиска по телефону
4. **COMPOSITE INDEX** на `(last_name, first_name)` для поиска по ФИО
5. **INDEX** на `created_at` для сортировки и фильтрации по дате создания

### Bookings
1. **PRIMARY KEY** на `id`
2. **INDEX** на `client_id` для связи с клиентами
3. **INDEX** на `status` для фильтрации по статусу
4. **COMPOSITE INDEX** на `(start_date, end_date)` для поиска пересекающихся бронирований
5. **COMPOSITE INDEX** на `(client_id, status)` для поиска активных бронирований клиента
6. **INDEX** на `created_at` для сортировки и фильтрации по дате создания

### Booking Items
1. **PRIMARY KEY** на `id`
2. **INDEX** на `booking_id` для связи с бронированиями
3. **INDEX** на `equipment_id` для связи с оборудованием
4. **COMPOSITE INDEX** на `(booking_id, equipment_id)` для уникальности оборудования в бронировании
5. **INDEX** на `created_at` для сортировки и фильтрации по дате создания

### Documents
1. **PRIMARY KEY** на `id`
2. **INDEX** на `booking_id` для связи с бронированиями
3. **INDEX** на `type` для фильтрации по типу документа
4. **UNIQUE INDEX** на `(type, number)` для уникальности номеров документов определенного типа
5. **COMPOSITE INDEX** на `(booking_id, type)` для поиска документов определенного типа для бронирования
6. **INDEX** на `created_at` для сортировки и фильтрации по дате создания

## Оптимизации

### Партиционирование
- Таблица `bookings` партиционируется по `created_at` для оптимизации исторических данных
- Таблица `documents` партиционируется по `type` для оптимизации доступа к разным типам документов

### Материализованные представления
1. **active_equipment_availability**
   - Обновляется каждые 5 минут
   - Содержит информацию о доступности оборудования на текущий момент
   - Используется для быстрого поиска доступного оборудования

2. **client_booking_statistics**
   - Обновляется раз в день
   - Содержит агрегированную статистику по бронированиям клиентов
   - Используется для аналитики и отчетов

### Настройки PostgreSQL
- `work_mem`: увеличен для оптимизации сортировки и хеширования
- `maintenance_work_mem`: увеличен для оптимизации создания индексов
- `effective_cache_size`: настроен в соответствии с доступной памятью
- `random_page_cost`: оптимизирован для SSD
- `default_statistics_target`: увеличен для более точного планирования запросов 