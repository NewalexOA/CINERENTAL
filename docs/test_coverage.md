# Документация по тестовому покрытию

## Обзор

Система CINERENTAL использует комплексный набор тестов, включающий модульные (unit) тесты, интеграционные тесты и сквозные тесты. Тесты написаны с использованием pytest и pytest-asyncio для поддержки асинхронного тестирования.

## Структура тестов

```
tests/
├── conftest.py              # Глобальная конфигурация и фикстуры
├── unit/                    # Модульные тесты
│   ├── test_booking_service.py    # Тесты сервиса бронирования
│   ├── test_category_service.py   # Тесты сервиса категорий
│   ├── test_client_service.py     # Тесты сервиса клиентов
│   ├── test_document_service.py   # Тесты сервиса документов
│   └── test_equipment_service.py  # Тесты сервиса оборудования
├── integration/             # Интеграционные тесты
    ├── conftest.py         # Фикстуры для интеграционных тестов
    ├── test_categories.py  # Тесты эндпоинтов категорий
    ├── test_business_processes.py  # Тесты бизнес-процессов
    ├── test_edge_cases.py  # Тесты граничных случаев
    └── test_service_interactions.py # Тесты взаимодействия сервисов
```

## Типы тестов

### Модульные тесты (Unit Tests)

#### Тесты сервиса бронирования (`test_booking_service.py`)
- Создание бронирования
- Получение информации о бронировании
- Обновление бронирования
- Изменение статуса бронирования
- Проверка активных бронирований
- Работа с просроченными бронированиями
- Управление платежами

#### Тесты сервиса категорий (`test_category_service.py`)
- Создание категорий
- Обновление категорий
- Поиск категорий
- Подсчет оборудования в категориях
- Управление иерархией категорий

#### Тесты сервиса клиентов (`test_client_service.py`)
- Регистрация клиентов
- Обновление данных клиентов
- Управление статусом клиентов
- Поиск клиентов
- Работа с активными бронированиями клиентов

#### Тесты сервиса документов (`test_document_service.py`)
- Создание документов
- Обновление документов
- Управление статусами документов
- Поиск документов
- Работа с датами документов

#### Тесты сервиса оборудования (`test_equipment_service.py`)
- Добавление оборудования
- Обновление оборудования
- Управление статусом оборудования
- Проверка доступности
- Поиск по штрих-коду

### Интеграционные тесты

#### Тесты бизнес-процессов (`test_business_processes.py`)
- Полный цикл бронирования
- Процесс документооборота
- Управление статусами оборудования
- Обработка платежей
- Иерархия категорий

#### Тесты граничных случаев (`test_edge_cases.py`)
- Валидация дат бронирования
- Переходы статусов документов
- Проверка доступности оборудования
- Мягкое удаление
- Изменения статусов оборудования
- Управление статусами бронирования

#### Тесты взаимодействия сервисов (`test_service_interactions.py`)
- Процесс бронирования с документами
- Полный цикл бронирования
- Проверка доступности оборудования
- Пересекающиеся бронирования

## Фикстуры

### Глобальные фикстуры (`conftest.py`)
- `async_test`: Декоратор для асинхронных тестов
- `async_fixture`: Декоратор для асинхронных фикстур
- `db_session`: Сессия базы данных
- `test_db_setup`: Инициализация тестовой базы данных

### Фикстуры для тестов
- `test_category`: Тестовая категория
- `test_equipment`: Тестовое оборудование
- `test_client`: Тестовый клиент
- `test_booking`: Тестовое бронирование
- Сервисные фикстуры:
  - `booking_service`
  - `document_service`
  - `equipment_service`
  - `category_service`
  - `client_service`

## Области покрытия

### Бизнес-логика
- Процесс бронирования
- Обработка платежей
- Управление документами
- Доступность оборудования
- Иерархия категорий

### Управление данными
- Мягкое удаление
- Переходы статусов
- Управление связями
- Валидация данных

### Обработка ошибок
- Недопустимые операции
- Несуществующие ресурсы
- Дублирование записей
- Нарушения в переходах статусов

## Запуск тестов

```bash
# Запуск всех тестов с отчетом о покрытии
docker-compose run test

# Запуск конкретного файла с тестами
docker-compose run test pytest tests/integration/test_categories.py -v

# Запуск тестов с определенным маркером
docker-compose run test pytest -m "asyncio" -v
```

## Отчет о покрытии

Набор тестов генерирует отчет о покрытии в формате HTML, доступный в директории `htmlcov` после выполнения тестов.

## Лучшие практики

1. **Асинхронное тестирование**
   - Использование декоратора `async_test`
   - Использование декоратора `async_fixture`
   - Корректная обработка корутин

2. **Управление базой данных**
   - Использование изолированной тестовой базы
   - Очистка после тестов
   - Изоляция транзакций

3. **Организация тестов**
   - Группировка связанных тестов в классы
   - Описательные имена тестов
   - Документирование назначения тестов

4. **Фикстуры**
   - Минимальные и целевые фикстуры
   - Правильный выбор области видимости
   - Документирование назначения фикстур

5. **Обработка ошибок**
   - Тестирование успешных и неуспешных сценариев
   - Проверка сообщений об ошибках
   - Тестирование граничных случаев

## Планы по улучшению

1. Добавить тесты производительности
2. Внедрить тесты контрактов API
3. Расширить покрытие граничных случаев
4. Улучшить документацию тестов
5. Добавить нагрузочное тестирование
6. Внедрить тесты безопасности
7. Расширить интеграционные тесты
8. Добавить тесты для новых функций
