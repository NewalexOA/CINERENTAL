# Тестирование CINERENTAL

## Структура тестового окружения

Тестовое окружение построено на Docker Compose и включает следующие сервисы:

```yaml
services:
  test:        # Сервис для запуска тестов
  test_db:     # Отдельная БД для тестов
  redis:       # Redis для тестов и основного приложения
```

### Тестовая база данных

Для тестов используется отдельная база данных PostgreSQL:

```yaml
test_db:
  image: postgres:14
  volumes:
    - postgres_test_data:/var/lib/postgresql/data  # Отдельный volume для тестовой БД
  environment:
    - POSTGRES_DB=cinerental_test                  # Имя тестовой БД
  ports:
    - "5433:5432"                                  # Порт 5433 на хосте, 5432 в контейнере
```

Особенности:
- Изолированная от основной БД
- Отдельный volume для данных
- Доступна на порту 5433 на хост-машине
- Автоматически создается при первом запуске

### Тестовый сервис

Сервис для запуска тестов настроен следующим образом:

```yaml
test:
  build: .
  entrypoint: ./docker/run-tests.sh                # Точка входа - скрипт запуска тестов
  volumes:
    - .:/app                                       # Монтируем код
    - ./htmlcov:/app/htmlcov                       # Монтируем отчеты о покрытии
  environment:
    - POSTGRES_SERVER=test_db                      # Используем тестовую БД
    - POSTGRES_DB=cinerental_test
    - TESTING=1                                    # Флаг тестового режима
```

## Запуск тестов

### Скрипт запуска

Тесты запускаются через скрипт `docker/run-tests.sh`, который:
1. Проверяет готовность сервисов (PostgreSQL и Redis)
2. Применяет миграции к тестовой БД
3. Запускает тесты с переданными аргументами
4. Генерирует отчет о покрытии кода

### Примеры использования

```bash
# Запуск конкретного теста
docker compose run --rm test tests/unit/test_equipment_service.py::test_create_equipment

# Запуск всех тестов в директории
docker compose run --rm test tests/unit/

# Запуск с дополнительными опциями pytest
docker compose run --rm test tests/integration/ -v -x

# Запуск тестов с определенной меткой
docker compose run --rm test -m "integration"
```

### Опции запуска

При запуске без аргументов скрипт показывает справку:
```bash
docker compose run --rm test
```

Поддерживаются все стандартные опции pytest:
- `-v`: подробный вывод
- `-x`: остановка после первой ошибки
- `-k`: фильтрация тестов по имени
- `-m`: фильтрация тестов по меткам
- `--pdb`: запуск отладчика при ошибке

## Отчеты о покрытии

При запуске тестов автоматически генерируются отчеты о покрытии кода:
- HTML-отчет в директории `htmlcov/`
- Консольный отчет с детализацией непокрытых строк

## Преимущества архитектуры

1. **Изоляция:**
   - Отдельная тестовая база данных
   - Чистое окружение при каждом запуске
   - Независимость от основного приложения

2. **Гибкость:**
   - Возможность запуска отдельных тестов
   - Поддержка всех опций pytest
   - Настраиваемые отчеты о покрытии

3. **Воспроизводимость:**
   - Тесты запускаются в том же окружении, что и приложение
   - Docker гарантирует одинаковое окружение на всех машинах
   - Автоматическое применение миграций

4. **Удобство:**
   - Простой запуск через Docker Compose
   - Автоматическая генерация отчетов
   - Понятные сообщения об ошибках

## Структура тестов

```
tests/
├── unit/                  # Модульные тесты
│   ├── test_equipment_service.py
│   ├── test_booking_service.py
│   └── ...
├── integration/           # Интеграционные тесты
│   ├── test_equipment_api.py
│   ├── test_booking_api.py
│   └── ...
└── conftest.py           # Общие фикстуры
```

## Рекомендации по написанию тестов

1. **Изоляция тестов:**
   - Каждый тест должен быть независимым
   - Используйте фикстуры для подготовки данных
   - Очищайте данные после тестов

2. **Именование:**
   - Тестовые файлы: `test_*.py`
   - Тестовые функции: `test_*`
   - Имена должны отражать что тестируется

3. **Организация:**
   - Группируйте связанные тесты в классы
   - Используйте маркеры для категоризации
   - Следуйте структуре приложения

4. **Покрытие:**
   - Стремитесь к высокому покрытию кода
   - Тестируйте граничные случаи
   - Проверяйте обработку ошибок 