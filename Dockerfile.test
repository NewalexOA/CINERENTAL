FROM python:3.12-alpine

# Set environment variables with default values that can be overridden at build time
ARG PIP_INDEX_URL=https://pypi.org/simple/
ARG PIP_TRUSTED_HOST=pypi.org
ARG APT_MIRROR=http://deb.debian.org/debian

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    UV_SYSTEM_PYTHON=1 \
    PIP_INDEX_URL=${PIP_INDEX_URL} \
    PIP_TRUSTED_HOST=${PIP_TRUSTED_HOST} \
    UV_INDEX_URL=${PIP_INDEX_URL}

# Install system dependencies including Playwright requirements
RUN apk add --no-cache \
    build-base \
    curl \
    postgresql-dev \
    python3-dev \
    ghostscript \
    postgresql-client \
    netcat-openbsd \
    # Playwright dependencies
    glib \
    nss \
    nspr \
    at-spi2-atk \
    at-spi2-core \
    libxcomposite \
    libxdamage \
    libxext \
    libxfixes \
    libxrandr \
    mesa-gl \
    libxkbcommon \
    alsa-lib

# Set working directory
WORKDIR /app

# Install uv
RUN curl -LsSf https://astral.sh/uv/install.sh | sh && \
    echo 'export PATH="/root/.local/bin:$PATH"' >> ~/.bashrc && \
    export PATH="/root/.local/bin:$PATH"

# Create all necessary directories
RUN mkdir -p backend tests docker frontend frontend/static \
    media static templates alembic && \
    touch alembic.ini && \
    chmod -R 777 frontend media static templates alembic

# Copy files individually to avoid errors
COPY pyproject.toml .
COPY README.md .
COPY backend/. backend/
COPY tests/. tests/
COPY docker/. docker/

# Install test dependencies
RUN export PATH="/root/.local/bin:$PATH" && \
    uv pip install --system . && \
    uv pip install --system \
    pytest==7.4.0 \
    pytest-asyncio==0.21.1 \
    pytest-cov==4.1.0 \
    pytest-mock==3.11.1 \
    pytest-playwright==0.7.0 \
    httpx \
    coverage \
    requests \
    psycopg2-binary \
    faker \
    factory-boy \
    treepoem \
    playwright

# Install Playwright browser
RUN playwright install chromium

# Make scripts executable
RUN chmod +x docker/wait-for.sh docker/run-tests.sh

CMD ["./docker/run-tests.sh"]
