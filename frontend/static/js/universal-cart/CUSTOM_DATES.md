# Custom Dates Feature for Universal Cart

## Обзор

Функциональность кастомных дат позволяет пользователям устанавливать индивидуальные даты аренды для каждого элемента в корзине, независимо от дат проекта.

## Возможности

- **Даты проекта по умолчанию**: Все новые элементы используют даты проекта
- **Кастомные даты**: Возможность установить индивидуальные даты для любого элемента
- **Визуальные индикаторы**: Различное отображение для проектных и кастомных дат
- **Интуитивный интерфейс**: Клик по дате открывает модальное окно редактирования
- **Интеграция с существующим datepicker**: Использует тот же UI что и в других частях системы

## Структура данных

### Поля элемента корзины

```javascript
{
    id: 123,
    name: "Camera Sony A7S",
    quantity: 1,
    // Новые поля для дат
    custom_start_date: "2024-01-15", // или null
    custom_end_date: "2024-01-20",   // или null
    use_project_dates: true,         // true/false
    // остальные поля...
}
```

### Логика выбора дат

1. **use_project_dates === true**: Использовать даты проекта (по умолчанию)
2. **use_project_dates === false && custom dates set**: Использовать кастомные даты
3. **Fallback**: Даты проекта если кастомные не установлены

## UI Компоненты

### Отображение дат в корзине

```html
<div class="cart-item-dates">
    <div class="date-display project-dates" data-item-key="123_serial">
        <i class="fas fa-calendar-alt"></i>
        <span class="dates-text">15.01.2024 - 20.01.2024</span>
        <i class="fas fa-edit edit-icon"></i>
    </div>
</div>
```

### CSS классы

- `.date-display.project-dates`: Синий фон для дат проекта
- `.date-display.custom-dates`: Желтый фон для кастомных дат
- `.edit-icon`: Иконка редактирования с hover эффектом

### Модальное окно редактирования

- Радиокнопки выбора типа дат
- Отображение текущих дат проекта
- Datepicker для кастомных дат
- Валидация введенных дат

## API Changes

### UniversalCart.updateItemDates()

```javascript
// Установить кастомные даты
await cart.updateItemDates(itemKey, "2024-01-15", "2024-01-20");

// Сбросить на даты проекта
await cart.updateItemDates(itemKey, null, null);
```

### События

```javascript
cart.on('itemDatesUpdated', (data) => {
    console.log('Dates updated for:', data.item.name);
    console.log('Use project dates:', data.useProjectDates);
});
```

## Интеграция с бронированиями

### Подготовка данных

В `_prepareBookingsData()` каждый элемент использует свои даты:

```javascript
// Если установлены кастомные даты
if (item.use_project_dates === false && item.custom_start_date) {
    startDate = item.custom_start_date;
    endDate = item.custom_end_date;
} else {
    // Fallback на даты проекта
    startDate = config.startDate;
    endDate = config.endDate;
}
```

### Батч операции

В `addEquipmentBatchToProject()` каждый элемент корзины обрабатывается со своими датами.

## Пользовательский интерфейс

### Использование

1. **Добавление в корзину**: Элементы добавляются с датами проекта по умолчанию
2. **Редактирование дат**: Клик на блок с датами → модальное окно
3. **Выбор типа дат**: Радиокнопки "Даты проекта" / "Кастомные даты"
4. **Ввод кастомных дат**: Datepicker с тем же UI что и в остальной системе
5. **Сохранение**: Кнопка "Сохранить" применяет изменения

### Визуальные индикаторы

- **Синий фон**: Элемент использует даты проекта
- **Желтый фон**: Элемент использует кастомные даты
- **Hover эффект**: При наведении показывается иконка редактирования
- **Tooltip**: "Кликните для изменения дат"

## Совместимость

- Работает с существующими элементами корзины
- Обратная совместимость: старые элементы автоматически используют даты проекта
- Интеграция с existing project workflow
- Использует moment.js и daterangepicker как в остальной системе

## Техническая реализация

### Файлы изменены

1. **core/universal-cart.js**: Добавлен `updateItemDates()` метод
2. **ui/cart-templates.js**: Обновлен шаблон элемента корзины
3. **ui/cart-renderer.js**: Добавлена логика отображения дат
4. **handlers/cart-event-handler.js**: Добавлены обработчики кликов и модальное окно
5. **project/cart/cart-operations.js**: Обновлена логика создания бронирований
6. **universal-cart.css**: Добавлены стили для дат

### Новые методы

- `UniversalCart.updateItemDates(itemKey, startDate, endDate)`
- `CartRenderer._getItemDatesDisplay(item)`
- `CartEventHandler._handleDateEdit(itemKey)`
- `CartEventHandler._showDatePickerModal(itemKey, item)`

## Тестирование

### Сценарии тестирования

1. **Добавление элемента**: Проверить что используются даты проекта
2. **Изменение на кастомные**: Клик → выбор кастомных дат → сохранение
3. **Возврат к проектным**: Клик → выбор дат проекта → сохранение
4. **Создание бронирований**: Проверить что используются правильные даты
5. **Батч операции**: Проверить что каждый элемент использует свои даты

### Edge Cases

- Отсутствие дат проекта
- Невалидные кастомные даты
- Пустая корзина
- Элементы без серийных номеров
- Элементы с серийными номерами

## Будущие улучшения

- Групповое редактирование дат
- Шаблоны дат (weekends, holidays)
- Валидация конфликтов при изменении дат
- Календарная визуализация
- Экспорт/импорт настроек дат
