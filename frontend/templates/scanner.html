{% extends "base.html" %}

{% block title %}Сканер - {{ APP_NAME }}{% endblock %}

{% block extra_css %}
<style>
    /* Стили для временной шкалы и истории оборудования */
    .timeline {
        position: relative;
        padding: 1em 0;
    }

    .timeline::before {
        content: '';
        position: absolute;
        top: 0;
        left: 18px;
        height: 100%;
        width: 2px;
        background: #e9ecef;
    }

    .timeline-item {
        position: relative;
        margin-bottom: 1.5em;
        padding-left: 45px;
    }

    .timeline-badge {
        position: absolute;
        left: 0;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
    }

    .timeline-content {
        padding: 1em;
        border-radius: 0.375rem;
        background: #f8f9fa;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1>Сканер штрих-кодов</h1>
        <p class="lead">Сканируйте штрих-коды оборудования для быстрого доступа к информации</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Scanner View -->
        <div class="card mb-4">
            <div class="card-body text-center">
                <h3 class="card-title">Сканер оборудования</h3>
                <p class="card-text">Отсканируйте штрих-код оборудования для поиска в системе</p>
                <img src="{{ url_for('static', path='img/act.png') }}" alt="Сканирование штрих-кода" class="img-fluid" style="max-height: 200px;">
                <div id="scannerErrorContainer" class="alert alert-danger mt-3 d-none">
                    <i class="fas fa-exclamation-triangle"></i> <span id="scannerErrorText"></span>
                    <div class="mt-2 text-start">
                        <small>
                            <strong>Рекомендации:</strong>
                            <ul class="mb-0">
                                <li>Убедитесь, что у вас правильная раскладка клавиатуры (английская)</li>
                                <li>Проверьте, что штрих-код не содержит недопустимых символов</li>
                                <li>Убедитесь, что оборудование с таким штрих-кодом существует в системе</li>
                            </ul>
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scan Session -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Текущая сессия сканирования</h5>
                <div class="btn-group">
                    <button class="btn btn-sm btn-primary" id="newSessionBtn">
                        <i class="fas fa-plus"></i> Новая сессия
                    </button>
                    <button class="btn btn-sm btn-outline-primary" id="loadSessionBtn">
                        <i class="fas fa-folder-open"></i> Загрузить
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="manageSessionsBtn">
                        <i class="fas fa-cog"></i> Управление
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="activeSessionContainer">
                    <div class="text-center text-muted py-3" id="noActiveSessionMessage">
                        <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                        <p>Нет активной сессии сканирования.<br>Создайте новую или загрузите существующую.</p>
                    </div>
                    <div id="activeSessionInfo" class="d-none">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0" id="sessionName">Название сессии</h6>
                            <div>
                                <span class="badge bg-info me-2" id="itemCount">0 позиций</span>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary" id="renameSessionBtn" title="Переименовать сессию">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger" id="clearSessionBtn" title="Очистить сессию">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="list-group" id="sessionItemsList">
                            <!-- Список отсканированных позиций будет здесь -->
                        </div>
                        <div class="d-grid gap-2 mt-3">
                            <button class="btn btn-success" id="syncSessionBtn">
                                <i class="fas fa-sync"></i> Синхронизировать с сервером
                            </button>
                            <button class="btn btn-primary" id="createProjectBtn">
                                <i class="fas fa-project-diagram"></i> Создать проект из сессии
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scan History -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">История сканирования</h5>
            </div>
            <div class="card-body">
                <div class="list-group list-group-flush" id="scanHistory">
                    <!-- История сканирования будет добавляться здесь -->
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Scan Result -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Результат сканирования</h5>
            </div>
            <div class="card-body" id="scanResult">
                <div class="text-center text-muted py-5">
                    <i class="fas fa-barcode fa-3x mb-3"></i>
                    <p>Отсканируйте штрих-код, чтобы увидеть информацию</p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Быстрые действия</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" id="createBooking" disabled>
                        <i class="fas fa-calendar-plus"></i> Создать бронирование
                    </button>
                    <button class="btn btn-outline-primary" id="updateStatus" disabled>
                        <i class="fas fa-sync"></i> Обновить статус
                    </button>
                    <button class="btn btn-outline-primary" id="viewHistory" disabled>
                        <i class="fas fa-history"></i> История оборудования
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Update Status Modal -->
<div class="modal fade" id="updateStatusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Обновить статус</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="updateStatusForm">
                    <input type="hidden" name="equipment_id">
                    <div class="mb-3">
                        <label class="form-label">Новый статус</label>
                        <select class="form-select" name="status" required>
                            <option value="AVAILABLE">Доступно</option>
                            <option value="RENTED">В аренде</option>
                            <option value="MAINTENANCE">В ремонте</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Комментарий</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveStatus">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Equipment History Modal -->
<div class="modal fade" id="historyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">История оборудования</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#statusHistory">
                            Статусы
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#bookingHistory">
                            Бронирования
                        </button>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="statusHistory">
                        <div class="timeline">
                            <!-- История статусов будет добавляться здесь -->
                        </div>
                    </div>
                    <div class="tab-pane fade" id="bookingHistory">
                        <div class="list-group list-group-flush">
                            <!-- История бронирований будет добавляться здесь -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Session Modal -->
<div class="modal fade" id="newSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Новая сессия сканирования</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="newSessionForm">
                    <div class="mb-3">
                        <label class="form-label">Название сессии</label>
                        <input type="text" class="form-control" name="session_name" required placeholder="Введите название сессии">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="createSessionBtn">Создать</button>
            </div>
        </div>
    </div>
</div>

<!-- Load Session Modal -->
<div class="modal fade" id="loadSessionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Загрузить сессию сканирования</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs mb-3" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#localSessions">
                            Локальные сессии
                        </button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#serverSessions">
                            Серверные сессии
                        </button>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="localSessions">
                        <div class="list-group" id="localSessionsList">
                            <!-- Список локальных сессий будет добавляться здесь -->
                        </div>
                    </div>
                    <div class="tab-pane fade" id="serverSessions">
                        <div class="list-group" id="serverSessionsList">
                            <!-- Список серверных сессий будет добавляться здесь -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Rename Session Modal -->
<div class="modal fade" id="renameSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Переименовать сессию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="renameSessionForm">
                    <div class="mb-3">
                        <label class="form-label">Новое название</label>
                        <input type="text" class="form-control" name="new_name" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveRenameBtn">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Sessions Modal -->
<div class="modal fade" id="manageSessionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Управление сессиями сканирования</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between mb-3">
                    <h6>Локальные сессии</h6>
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" id="refreshSessionsListBtn">
                            <i class="fas fa-sync"></i> Обновить
                        </button>
                        <button class="btn btn-outline-danger" id="cleanExpiredSessionsBtn">
                            <i class="fas fa-broom"></i> Очистить устаревшие
                        </button>
                        <button class="btn btn-outline-danger" id="resetAllSessionsBtn">
                            <i class="fas fa-trash"></i> Сбросить всё
                        </button>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Название</th>
                                <th>Создана</th>
                                <th>Обновлена</th>
                                <th>Позиций</th>
                                <th>Синхронизирована</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="sessionsList">
                            <!-- Sessions list will be here -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Connect the script for working with scanning sessions -->
<script src="{{ url_for('static', path='js/scan-storage.js') }}"></script>
<script>
let scanner = null;
let currentEquipment = null;

// Initialize scanner
async function initScanner() {
    try {
        scanner = new BarcodeScanner();

        // Override scanner handlers
        scanner.onScan = handleScan;
        scanner.onError = handleError;

        // Start listening for scanner input
        scanner.start();
        updateScannerControls(true);

        // Initialize session management
        initSessionManagement();
    } catch (error) {
        console.error('Error initializing scanner:', error);
        showToast('Ошибка инициализации сканера', 'danger');
    }
}

// Initialize session management
function initSessionManagement() {
    // Check for active session
    const activeSession = scanStorage.getActiveSession();
    updateSessionUI(activeSession);

    // Event listeners for session management
    document.getElementById('newSessionBtn').addEventListener('click', showNewSessionModal);
    document.getElementById('loadSessionBtn').addEventListener('click', showLoadSessionModal);
    document.getElementById('manageSessionsBtn').addEventListener('click', showManageSessionsModal);
    document.getElementById('renameSessionBtn').addEventListener('click', showRenameSessionModal);
    document.getElementById('clearSessionBtn').addEventListener('click', confirmClearSession);
    document.getElementById('syncSessionBtn').addEventListener('click', syncActiveSession);
    document.getElementById('createProjectBtn').addEventListener('click', createProjectFromSession);
    document.getElementById('createSessionBtn').addEventListener('click', createNewSession);
    document.getElementById('saveRenameBtn').addEventListener('click', renameActiveSession);
    document.getElementById('refreshSessionsListBtn').addEventListener('click', refreshSessionsList);
    document.getElementById('cleanExpiredSessionsBtn').addEventListener('click', cleanExpiredSessions);
    document.getElementById('resetAllSessionsBtn').addEventListener('click', resetAllSessions);
}

// Update session UI based on active session
function updateSessionUI(session) {
    const noActiveSessionMessage = document.getElementById('noActiveSessionMessage');
    const activeSessionInfo = document.getElementById('activeSessionInfo');

    if (session) {
        // Hide message, show session info
        noActiveSessionMessage.classList.add('d-none');
        activeSessionInfo.classList.remove('d-none');

        // Update session info
        document.getElementById('sessionName').textContent = session.name;
        document.getElementById('itemCount').textContent = `${session.items.length} позиций`;

        // Update items list
        const itemsList = document.getElementById('sessionItemsList');
        itemsList.innerHTML = '';

        if (session.items.length === 0) {
            itemsList.innerHTML = '<div class="text-center text-muted py-2">Нет отсканированного оборудования</div>';
        } else {
            session.items.forEach(item => {
                const itemElement = document.createElement('div');
                itemElement.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                itemElement.innerHTML = `
                    <div>
                        <h6 class="mb-0">${item.name}</h6>
                        <small class="text-muted">${item.barcode}</small>
                    </div>
                    <button class="btn btn-sm btn-outline-danger remove-item-btn" data-equipment-id="${item.equipment_id}">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                itemsList.appendChild(itemElement);
            });

            // Add event listeners for remove buttons
            document.querySelectorAll('.remove-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const equipmentId = parseInt(e.currentTarget.getAttribute('data-equipment-id'));
                    removeEquipmentFromSession(equipmentId);
                });
            });
        }
    } else {
        // Show message, hide session info
        noActiveSessionMessage.classList.remove('d-none');
        activeSessionInfo.classList.add('d-none');
    }
}

// Show new session modal
function showNewSessionModal() {
    const modal = new bootstrap.Modal('#newSessionModal');
    document.getElementById('newSessionForm').reset();
    modal.show();
}

// Create new session
function createNewSession() {
    const form = document.getElementById('newSessionForm');
    const sessionName = form.elements.session_name.value.trim();

    if (!sessionName) {
        showToast('Введите название сессии', 'warning');
        return;
    }

    const session = scanStorage.createSession(sessionName);
    updateSessionUI(session);

    // Hide modal
    bootstrap.Modal.getInstance('#newSessionModal').hide();
    showToast('Сессия успешно создана', 'success');
}

// Show load session modal
function showLoadSessionModal() {
    // Populate local sessions
    const localSessions = scanStorage.getSessions();
    const localSessionsList = document.getElementById('localSessionsList');

    if (localSessions.length === 0) {
        localSessionsList.innerHTML = '<div class="text-center text-muted py-3">Нет сохраненных сессий</div>';
    } else {
        localSessionsList.innerHTML = '';
        localSessions.forEach(session => {
            const lastUpdate = new Date(session.updatedAt).toLocaleString();
            const sessionElement = document.createElement('a');
            sessionElement.href = '#';
            sessionElement.className = 'list-group-item list-group-item-action';
            sessionElement.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${session.name}</h6>
                    <small>${session.items.length} позиций</small>
                </div>
                <small class="text-muted">Обновлено: ${lastUpdate}</small>
            `;
            sessionElement.addEventListener('click', (e) => {
                e.preventDefault();
                scanStorage.setActiveSession(session.id);
                updateSessionUI(session);
                bootstrap.Modal.getInstance('#loadSessionModal').hide();
                showToast('Сессия загружена', 'success');
            });
            localSessionsList.appendChild(sessionElement);
        });
    }

    // Show modal
    const modal = new bootstrap.Modal('#loadSessionModal');
    modal.show();

    // Load server sessions when switching to that tab
    document.querySelector('button[data-bs-target="#serverSessions"]').addEventListener('click', loadServerSessions);
}

// Load server sessions
async function loadServerSessions() {
    const serverSessionsList = document.getElementById('serverSessionsList');
    serverSessionsList.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div></div>';

    try {
        // Assume user ID is available in some way, for demo we'll use 1
        const userId = 1; // This should be replaced with actual user ID
        const serverSessions = await scanSync.getUserSessionsFromServer(userId);

        if (serverSessions.length === 0) {
            serverSessionsList.innerHTML = '<div class="text-center text-muted py-3">Нет сохраненных сессий на сервере</div>';
        } else {
            serverSessionsList.innerHTML = '';
            serverSessions.forEach(session => {
                const lastUpdate = new Date(session.updated_at).toLocaleString();
                const sessionElement = document.createElement('a');
                sessionElement.href = '#';
                sessionElement.className = 'list-group-item list-group-item-action';
                sessionElement.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${session.name}</h6>
                        <small>${session.items.length} позиций</small>
                    </div>
                    <small class="text-muted">Обновлено: ${lastUpdate}</small>
                `;
                sessionElement.addEventListener('click', async (e) => {
                    e.preventDefault();
                    try {
                        const importedSession = await scanSync.importSessionFromServer(session.id);
                        updateSessionUI(importedSession);
                        bootstrap.Modal.getInstance('#loadSessionModal').hide();
                    } catch (error) {
                        console.error('Error importing session:', error);
                        showToast('Ошибка импорта сессии', 'danger');
                    }
                });
                serverSessionsList.appendChild(sessionElement);
            });
        }
    } catch (error) {
        console.error('Error loading server sessions:', error);
        serverSessionsList.innerHTML = '<div class="text-center text-danger py-3">Ошибка загрузки сессий с сервера</div>';
    }
}

// Show rename session modal
function showRenameSessionModal() {
    const activeSession = scanStorage.getActiveSession();
    if (!activeSession) return;

    const form = document.getElementById('renameSessionForm');
    form.elements.new_name.value = activeSession.name;

    const modal = new bootstrap.Modal('#renameSessionModal');
    modal.show();
}

// Rename active session
function renameActiveSession() {
    const activeSession = scanStorage.getActiveSession();
    if (!activeSession) return;

    const form = document.getElementById('renameSessionForm');
    const newName = form.elements.new_name.value.trim();

    if (!newName) {
        showToast('Введите название сессии', 'warning');
        return;
    }

    const updatedSession = scanStorage.updateSessionName(activeSession.id, newName);
    updateSessionUI(updatedSession);

    // Hide modal
    bootstrap.Modal.getInstance('#renameSessionModal').hide();
    showToast('Сессия переименована', 'success');
}

// Confirm clearing session
function confirmClearSession() {
    const activeSession = scanStorage.getActiveSession();
    if (!activeSession) return;

    if (confirm('Вы уверены, что хотите очистить все позиции из текущей сессии?')) {
        const updatedSession = scanStorage.clearEquipment(activeSession.id);
        updateSessionUI(updatedSession);
        showToast('Сессия очищена', 'success');
    }
}

// Sync active session with server
async function syncActiveSession() {
    const activeSession = scanStorage.getActiveSession();
    if (!activeSession) return;

    try {
        const syncedSession = await scanSync.syncSessionWithServer(activeSession.id);
        updateSessionUI(syncedSession);
    } catch (error) {
        console.error('Error syncing session:', error);
        // Error toast is already shown in scanSync.syncSessionWithServer
    }
}

// Create project from session
function createProjectFromSession() {
    const activeSession = scanStorage.getActiveSession();
    if (!activeSession || activeSession.items.length === 0) {
        showToast('Нет оборудования для создания проекта', 'warning');
        return;
    }

    // Redirect to project creation page with session ID
    window.location.href = `/projects/new?session_id=${activeSession.id}`;
}

// Remove equipment from session
function removeEquipmentFromSession(equipmentId) {
    const activeSession = scanStorage.getActiveSession();
    if (!activeSession) return;

    const updatedSession = scanStorage.removeEquipment(activeSession.id, equipmentId);
    updateSessionUI(updatedSession);

    showToast('Оборудование удалено из сессии', 'success');
}

// Handle successful scan
async function handleScan(equipment) {
    currentEquipment = equipment;
    updateScanResult(equipment);
    updateQuickActions(true);
    addToScanHistory(equipment);

    // Add equipment to active session
    const activeSession = scanStorage.getActiveSession();
    if (activeSession) {
        // Format equipment for session
        const equipmentItem = {
            equipment_id: currentEquipment.id,
            barcode: currentEquipment.barcode,
            name: currentEquipment.name,
            category_name: currentEquipment.category_name
        };

        // Add to session
        const updatedSession = scanStorage.addEquipment(activeSession.id, equipmentItem);
        updateSessionUI(updatedSession);

        showToast('Оборудование автоматически добавлено в сессию', 'success');
    }
}

// Handle scan error
function handleError(error) {
    // Показываем сообщение об ошибке в контейнере ошибок сканера
    const errorContainer = document.getElementById('scannerErrorContainer');
    const errorText = document.getElementById('scannerErrorText');

    errorText.textContent = error.message;
    errorContainer.classList.remove('d-none');

    // Также показываем стандартный тост
    showToast(error.message, 'danger');

    // Обновляем отображение
    updateScanResult(null);
    updateQuickActions(false);

    // Автоматическое скрытие ошибки через 10 секунд
    setTimeout(() => {
        errorContainer.classList.add('d-none');
    }, 10000);
}

// Update scan result display
function updateScanResult(equipment) {
    const container = document.getElementById('scanResult');

    if (!equipment) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-barcode fa-3x mb-3"></i>
                <p>Отсканируйте штрих-код, чтобы увидеть информацию</p>
            </div>
        `;
        return;
    }

    container.innerHTML = `
        <div class="text-center mb-3">
            <span class="badge bg-${getStatusColor(equipment.status)} fs-5">
                ${equipment.status}
            </span>
        </div>
        <h5>${equipment.name}</h5>
        <p class="text-muted">${equipment.category_name}</p>
        <div class="mb-3">
            <small class="d-block"><strong>Серийный номер:</strong> ${equipment.serial_number}</small>
            <small class="d-block"><strong>Штрих-код:</strong> ${equipment.barcode}</small>
        </div>
        <div class="mb-3">
            <small class="d-block"><strong>Сумма материальной ответственности:</strong> ${equipment.replacement_cost} ₽</small>
        </div>
        <div class="text-center">
            <a href="/equipment/${equipment.id}" class="btn btn-sm btn-outline-primary">
                <i class="fas fa-info-circle"></i> Подробнее
            </a>
        </div>
    `;
}

// Add scan to history
function addToScanHistory(equipment) {
    const container = document.getElementById('scanHistory');
    const timestamp = moment().format('HH:mm:ss');

    const historyItem = document.createElement('div');
    historyItem.className = 'list-group-item';
    historyItem.innerHTML = `
        <div class="d-flex w-100 justify-content-between align-items-center">
            <div>
                <h6 class="mb-1">${equipment.name}</h6>
                <small class="text-muted">${equipment.category_name}</small>
            </div>
            <small class="text-muted">${timestamp}</small>
        </div>
    `;

    container.insertBefore(historyItem, container.firstChild);
}

// Update scanner control buttons
function updateScannerControls(isInitialized) {

    console.log(`Сканер ${isInitialized ? 'активен' : 'остановлен'}`);
}

// Update quick action buttons
function updateQuickActions(enabled) {
    // Update standard buttons
    document.getElementById('createBooking').disabled = !enabled;
    document.getElementById('updateStatus').disabled = !enabled;
    document.getElementById('viewHistory').disabled = !enabled;
}

// Load equipment history
async function loadEquipmentHistory(equipmentId) {
    try {
        const [statusHistory, bookingHistory] = await Promise.all([
            api.get(`/equipment/${equipmentId}/timeline`),
            api.get(`/equipment/${equipmentId}/bookings`)
        ]);

        // Update status history
        document.querySelector('#statusHistory .timeline').innerHTML = statusHistory.map(entry => `
            <div class="timeline-item">
                <div class="timeline-badge bg-${getStatusColor(entry.status)}">
                    <i class="fas fa-circle"></i>
                </div>
                <div class="timeline-content">
                    <h6 class="mb-1">${entry.status}</h6>
                    <small class="text-muted">${formatDate(entry.created_at)}</small>
                    ${entry.notes ? `<p class="mb-0">${entry.notes}</p>` : ''}
                </div>
            </div>
        `).join('');

        // Update booking history
        document.querySelector('#bookingHistory .list-group').innerHTML = bookingHistory.map(booking => `
            <a href="/bookings/${booking.id}" class="list-group-item list-group-item-action">
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${booking.client.name}</h6>
                    <small class="text-muted">${formatDate(booking.start_date)}</small>
                </div>
                <p class="mb-1">${formatDateRange(booking.start_date, booking.end_date)}</p>
                <small class="text-${getStatusColor(booking.status)}">${booking.status}</small>
            </a>
        `).join('');
    } catch (error) {
        console.error('Error loading equipment history:', error);
        showToast('Ошибка загрузки истории', 'danger');
    }
}

// Event Listeners
// document.getElementById('startScanner').addEventListener('click', () => {
//     scanner.start();
//     updateScannerControls(true);
// });

// document.getElementById('stopScanner').addEventListener('click', () => {
//     scanner.stop();
//     updateScannerControls(false);
// });

document.getElementById('updateStatus').addEventListener('click', () => {
    if (currentEquipment) {
        const form = document.getElementById('updateStatusForm');
        form.elements.equipment_id.value = currentEquipment.id;
        form.elements.status.value = currentEquipment.status;
        new bootstrap.Modal('#updateStatusModal').show();
    }
});

document.getElementById('saveStatus').addEventListener('click', async () => {
    const form = document.getElementById('updateStatusForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    try {
        await api.patch(`/equipment/${data.equipment_id}/status`, {
            status: data.status,
            notes: data.notes
        });

        showToast('Статус успешно обновлен', 'success');
        bootstrap.Modal.getInstance('#updateStatusModal').hide();

        // Refresh equipment data
        const equipment = await api.get(`/equipment/${data.equipment_id}`);
        handleScan(equipment);
    } catch (error) {
        console.error('Error updating status:', error);
        showToast('Ошибка при обновлении статуса', 'danger');
    }
});

document.getElementById('viewHistory').addEventListener('click', () => {
    if (currentEquipment) {
        loadEquipmentHistory(currentEquipment.id);
        new bootstrap.Modal('#historyModal').show();
    }
});

document.getElementById('createBooking').addEventListener('click', () => {
    if (currentEquipment) {
        window.location.href = `/bookings/?equipment=${currentEquipment.id}`;
    }
});

// Helper function for status colors
function getStatusColor(status) {
    const colors = {
        'AVAILABLE': 'success',
        'RENTED': 'warning',
        'MAINTENANCE': 'danger'
    };
    return colors[status] || 'secondary';
}

// Helper function for date formatting
function formatDateRange(start, end) {
    return `${formatDate(start)} - ${formatDate(end)}`;
}

// Show manage sessions modal
function showManageSessionsModal() {
    refreshSessionsList();
    const modal = new bootstrap.Modal('#manageSessionsModal');
    modal.show();
}

// Refresh sessions list
function refreshSessionsList() {
    const sessionsList = document.getElementById('sessionsList');
    const sessions = scanStorage.getSessions();

    if (sessions.length === 0) {
        sessionsList.innerHTML = '<tr><td colspan="6" class="text-center py-3">Нет сохраненных сессий</td></tr>';
        return;
    }

    sessionsList.innerHTML = '';

    sessions.forEach(session => {
        const createdDate = new Date(session.createdAt).toLocaleString();
        const updatedDate = new Date(session.updatedAt).toLocaleString();
        const isSynced = session.serverSessionId ? 'Да' : 'Нет';
        const isActive = scanStorage.getActiveSession()?.id === session.id;

        const row = document.createElement('tr');
        row.className = isActive ? 'table-primary' : '';

        row.innerHTML = `
            <td>${session.name} ${isActive ? '<span class="badge bg-primary">Активная</span>' : ''}</td>
            <td>${createdDate}</td>
            <td>${updatedDate}</td>
            <td>${session.items.length}</td>
            <td>${isSynced}</td>
            <td>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-outline-primary load-session-btn" data-session-id="${session.id}" title="Загрузить">
                        <i class="fas fa-folder-open"></i>
                    </button>
                    <button class="btn btn-outline-danger delete-session-btn" data-session-id="${session.id}" title="Удалить">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;

        sessionsList.appendChild(row);
    });

    // Add event listeners
    document.querySelectorAll('.load-session-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const sessionId = e.currentTarget.getAttribute('data-session-id');
            const session = scanStorage.setActiveSession(sessionId);
            updateSessionUI(session);
            bootstrap.Modal.getInstance('#manageSessionsModal').hide();
            showToast('Сессия активирована', 'success');
        });
    });

    document.querySelectorAll('.delete-session-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const sessionId = e.currentTarget.getAttribute('data-session-id');
            if (confirm('Вы уверены, что хотите удалить эту сессию?')) {
                scanStorage.deleteSession(sessionId);
                refreshSessionsList();

                // Update UI if active session was deleted
                const activeSession = scanStorage.getActiveSession();
                updateSessionUI(activeSession);

                showToast('Сессия удалена', 'success');
            }
        });
    });
}

// Clean expired sessions
function cleanExpiredSessions() {
    const removedCount = scanStorage.cleanExpiredSessions();

    if (removedCount > 0) {
        refreshSessionsList();
        showToast(`Удалено ${removedCount} устаревших сессий`, 'success');

        // Update UI if active session was removed
        const activeSession = scanStorage.getActiveSession();
        updateSessionUI(activeSession);
    } else {
        showToast('Устаревших сессий не найдено', 'info');
    }
}

// Reset all sessions (for debugging)
function resetAllSessions() {
    if (confirm('Вы уверены, что хотите удалить ВСЕ сессии? Это действие нельзя отменить.')) {
        localStorage.removeItem('equipment_scan_sessions');
        localStorage.removeItem('equipment_scan_sessions_active');

        showToast('Все сессии удалены', 'success');
        refreshSessionsList();

        // Create new session and update UI
        const newSession = scanStorage.createSession('Новая сессия ' + new Date().toLocaleString());
        updateSessionUI(newSession);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', initScanner);
</script>
{% endblock %}
