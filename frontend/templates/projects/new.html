{% extends "base.html" %}

{% block title %}Новый проект - {{ APP_NAME }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h1>Создание нового проекта</h1>
        <p class="lead">Создайте новый проект на основе отсканированного оборудования</p>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- Project Form -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Информация о проекте</h5>
            </div>
            <div class="card-body">
                <form id="projectForm">
                    <div class="mb-3">
                        <label for="projectName" class="form-label">Название проекта</label>
                        <input type="text" class="form-control" id="projectName" name="name" required>
                    </div>

                    <div class="mb-3">
                        <label for="clientSelect" class="form-label">Клиент</label>
                        <select class="form-select" id="clientSelect" name="client_id" required>
                            <option value="">Выберите клиента</option>
                            <!-- Список клиентов будет загружен динамически -->
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="projectDates" class="form-label">Период проекта</label>
                        <input type="text" class="form-control" id="projectDates" name="project_dates" required>
                    </div>

                    <div class="mb-3">
                        <label for="projectDescription" class="form-label">Описание</label>
                        <textarea class="form-control" id="projectDescription" name="description" rows="3"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="projectNotes" class="form-label">Примечания</label>
                        <textarea class="form-control" id="projectNotes" name="notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
        </div>

        <!-- Equipment List -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Оборудование в проекте</h5>
                <div class="text-muted" id="equipmentCount">0 позиций</div>
            </div>
            <div class="card-body">
                <div id="noEquipmentMessage" class="text-center text-muted py-4">
                    <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                    <p>Нет оборудования для создания проекта.<br>Вернитесь к сканеру и добавьте оборудование в сессию.</p>
                </div>

                <div id="equipmentList" class="d-none">
                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-primary btn-sm" id="applyProjectDatesBtn">
                            <i class="fas fa-calendar-check"></i> Применить даты проекта ко всем позициям
                        </button>
                    </div>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Оборудование</th>
                                <th>Период бронирования</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="equipmentItems">
                            <!-- Equipment list will be added dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Booking Summary -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Сводка бронирований</h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between mb-3">
                    <div>Всего позиций:</div>
                    <div><strong id="totalItems">0</strong></div>
                </div>
            </div>
            <div class="card-footer d-grid">
                <button type="button" class="btn btn-primary" id="createProjectBtn">
                    <i class="fas fa-project-diagram"></i> Создать проект
                </button>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- Session Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Сессия сканирования</h5>
            </div>
            <div class="card-body">
                <div id="sessionInfo">
                    <div class="d-flex justify-content-between mb-3">
                        <div>Название:</div>
                        <div><strong id="sessionName">-</strong></div>
                    </div>
                    <div class="d-flex justify-content-between mb-3">
                        <div>Создана:</div>
                        <div><strong id="sessionCreated">-</strong></div>
                    </div>
                    <div class="d-flex justify-content-between">
                        <div>Оборудование:</div>
                        <div><strong id="sessionItems">0</strong></div>
                    </div>
                </div>
            </div>
            <div class="card-footer d-grid">
                <a href="/scanner" class="btn btn-outline-primary">
                    <i class="fas fa-barcode"></i> Вернуться к сканеру
                </a>
            </div>
        </div>

        <!-- Help Information -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Информация</h5>
            </div>
            <div class="card-body">
                <p>Для создания проекта на основе сессии сканирования:</p>
                <ol>
                    <li>Заполните информацию о проекте</li>
                    <li>Укажите период бронирования для каждой единицы оборудования</li>
                    <li>Нажмите кнопку "Создать проект"</li>
                </ol>
                <p class="mb-0 mt-3 text-muted">После создания проекта вы сможете управлять им в разделе Проекты.</p>
            </div>
        </div>
    </div>
</div>

<!-- Equipment Period Modal -->
<div class="modal fade" id="equipmentPeriodModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Период бронирования</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="equipmentPeriodForm">
                    <input type="hidden" id="editEquipmentId" name="equipment_id">
                    <div class="mb-3">
                        <p class="mb-1" id="equipmentName"></p>
                        <small class="text-muted" id="equipmentBarcode"></small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Период бронирования</label>
                        <input type="text" class="form-control" id="equipmentPeriod" name="booking_period" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="saveEquipmentPeriodBtn">Сохранить</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Connect the script for working with scanning sessions -->
<script src="{{ url_for('static', path='js/scan-storage.js') }}"></script>
<script>
let sessionData = null;
let equipmentList = [];
let projectDateRange = null;

// Show local loader
function showLocalLoader() {
    const createButton = document.getElementById('createProjectBtn');
    if (createButton) {
        createButton.disabled = true;
        createButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Создание проекта...';
    }
}

// Hide local loader
function hideLocalLoader() {
    const createButton = document.getElementById('createProjectBtn');
    if (createButton) {
        createButton.disabled = false;
        createButton.innerHTML = '<i class="fas fa-project-diagram"></i> Создать проект';
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', () => {
    // First ensure loader is reset and hidden
    const loader = document.getElementById('global-loader');
    if (loader) {
        loader.setAttribute('hidden', '');
        if (getComputedStyle(loader).display !== 'none') {
            loader.style.display = 'none';
        }
    }
    window.loaderCounter = 0;

    // Get session ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const sessionId = urlParams.get('session_id');

    if (!sessionId) {
        showToast('ID сессии не указан', 'danger');
        setTimeout(() => {
            window.location.href = '/scanner';
        }, 2000);
        return;
    }

    // Load session data
    loadSessionData(sessionId);

    // Load clients for dropdown
    loadClients();

    // Initialize project date range picker
    initProjectDateRangePicker();

    // Add event listeners
    document.getElementById('createProjectBtn').addEventListener('click', createProject);
    document.getElementById('applyProjectDatesBtn').addEventListener('click', applyProjectDatesToAll);
});

// Load session data
function loadSessionData(sessionId) {
    sessionData = scanStorage.getSession(sessionId);

    if (!sessionData) {
        showToast('Сессия не найдена', 'danger');
        setTimeout(() => {
            window.location.href = '/scanner';
        }, 2000);
        return;
    }

    // Update session info
    document.getElementById('sessionName').textContent = sessionData.name;
    document.getElementById('sessionCreated').textContent = new Date(sessionData.updatedAt).toLocaleString();
    document.getElementById('sessionItems').textContent = sessionData.items.length;

    // Load equipment list
    loadEquipmentList(sessionData.items);
}

// Load equipment list
function loadEquipmentList(items) {
    equipmentList = items.map(item => {
        let equipment_id = item.equipment_id;

        if (!equipment_id && item.id) {
            equipment_id = item.id;
        }

        equipment_id = parseInt(equipment_id);

        if (isNaN(equipment_id)) {
            console.error('Некорректный ID оборудования в сессии:', item);
            return null;
        }

        return {
            ...item,
            equipment_id: equipment_id,
            bookingPeriod: null
        };
    }).filter(item => item !== null);

    console.log('Загружено оборудование:', equipmentList);
    updateEquipmentUI();
}

// Update equipment UI
function updateEquipmentUI() {
    const equipmentCount = document.getElementById('equipmentCount');
    const noEquipmentMessage = document.getElementById('noEquipmentMessage');
    const equipmentListContainer = document.getElementById('equipmentList');
    const equipmentItems = document.getElementById('equipmentItems');
    const totalItems = document.getElementById('totalItems');

    // Update counts
    equipmentCount.textContent = `${equipmentList.length} позиций`;
    totalItems.textContent = equipmentList.length;

    // Show/hide containers
    if (equipmentList.length === 0) {
        noEquipmentMessage.classList.remove('d-none');
        equipmentListContainer.classList.add('d-none');
    } else {
        noEquipmentMessage.classList.add('d-none');
        equipmentListContainer.classList.remove('d-none');

        // Render equipment list
        equipmentItems.innerHTML = '';
        equipmentList.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <div>${item.name}</div>
                    <small class="text-muted">${item.barcode}</small>
                </td>
                <td>
                    ${item.bookingPeriod
                        ? `<span class="badge bg-success">${item.bookingPeriod}</span>`
                        : '<span class="badge bg-warning">Не указан</span>'}
                </td>
                <td>
                    <button type="button" class="btn btn-sm btn-outline-primary set-period-btn" data-equipment-id="${item.equipment_id}">
                        <i class="fas fa-calendar"></i> Указать период
                    </button>
                </td>
            `;
            equipmentItems.appendChild(row);
        });

        // Add event listeners for set period buttons
        document.querySelectorAll('.set-period-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const equipmentId = parseInt(e.currentTarget.getAttribute('data-equipment-id'));
                showEquipmentPeriodModal(equipmentId);
            });
        });
    }
}

// Initialize project date range picker
function initProjectDateRangePicker() {
    const startDate = moment().startOf('day');
    const endDate = moment().add(7, 'days').endOf('day');

    projectDateRange = {
        startDate: startDate,
        endDate: endDate
    };

    $('#projectDates').daterangepicker({
        startDate: startDate,
        endDate: endDate,
        locale: {
            format: 'DD.MM.YYYY',
            applyLabel: 'Применить',
            cancelLabel: 'Отмена',
            fromLabel: 'С',
            toLabel: 'По',
            customRangeLabel: 'Произвольный период',
            daysOfWeek: ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'],
            monthNames: [
                'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
            ],
            firstDay: 1
        }
    }, (start, end) => {
        projectDateRange = {
            startDate: start,
            endDate: end
        };

        const hasEquipmentWithProjectDates = equipmentList.some(item => {
            if (item.bookingPeriod) {
                const [itemStart, itemEnd] = item.bookingPeriod.split(' - ');
                const prevStartDate = start.format('DD.MM.YYYY');
                const prevEndDate = end.format('DD.MM.YYYY');
                return itemStart === prevStartDate && itemEnd === prevEndDate;
            }
            return false;
        });

        if (hasEquipmentWithProjectDates) {
            const shouldUpdate = confirm('Обновить даты бронирования оборудования в соответствии с новыми датами проекта?');
            if (shouldUpdate) {
                applyProjectDatesToAll();
            }
        }
    });
}

// Load clients for select dropdown
async function loadClients() {
    try {
        const clients = await api.get('/clients');
        const select = document.getElementById('clientSelect');

        clients.forEach(client => {
            const option = document.createElement('option');
            option.value = client.id;
            option.textContent = client.name;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading clients:', error);
        showToast('Ошибка загрузки списка клиентов', 'danger');
    }
}

// Show equipment period modal
function showEquipmentPeriodModal(equipmentId) {
    const equipment = equipmentList.find(item => item.equipment_id === equipmentId);
    if (!equipment) return;

    // Set modal data
    document.getElementById('editEquipmentId').value = equipment.equipment_id;
    document.getElementById('equipmentName').textContent = equipment.name;
    document.getElementById('equipmentBarcode').textContent = `Штрих-код: ${equipment.barcode}`;

    // Initialize date range picker
    const startDate = equipment.bookingPeriod
        ? moment(equipment.bookingPeriod.split(' - ')[0], 'DD.MM.YYYY')
        : (projectDateRange ? projectDateRange.startDate : moment().startOf('day'));

    const endDate = equipment.bookingPeriod
        ? moment(equipment.bookingPeriod.split(' - ')[1], 'DD.MM.YYYY')
        : (projectDateRange ? projectDateRange.endDate : moment().add(7, 'days').endOf('day'));

    $('#equipmentPeriod').daterangepicker({
        startDate: startDate,
        endDate: endDate,
        locale: {
            format: 'DD.MM.YYYY',
            applyLabel: 'Применить',
            cancelLabel: 'Отмена',
            fromLabel: 'С',
            toLabel: 'По',
            customRangeLabel: 'Произвольный период',
            daysOfWeek: ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'],
            monthNames: [
                'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
                'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
            ],
            firstDay: 1
        }
    });

    // Set up save button
    document.getElementById('saveEquipmentPeriodBtn').onclick = saveEquipmentPeriod;

    // Show modal
    new bootstrap.Modal('#equipmentPeriodModal').show();
}

// Save equipment period
async function saveEquipmentPeriod() {
    const equipmentId = document.getElementById('editEquipmentId').value;
    const dateRange = $('#equipmentPeriod').data('daterangepicker');
    const startDate = dateRange.startDate.format('YYYY-MM-DD');
    const endDate = dateRange.endDate.format('YYYY-MM-DD');

    try {
        showLocalLoader();
        const isAvailable = await checkEquipmentAvailability(equipmentId, startDate, endDate);

        if (isAvailable) {
            const equipment = equipmentList.find(item => item.equipment_id === parseInt(equipmentId));
            if (equipment) {
                equipment.bookingPeriod = dateRange.startDate.format('DD.MM.YYYY') + ' - ' + dateRange.endDate.format('DD.MM.YYYY');
                renderEquipmentList();

                const modal = bootstrap.Modal.getInstance(document.getElementById('equipmentPeriodModal'));
                modal.hide();

                showToast('Период бронирования сохранен', 'success');
            }
        }
    } catch (error) {
        console.error('Ошибка при сохранении периода:', error);
        showToast('Ошибка при сохранении периода', 'danger');
    } finally {
        hideLocalLoader();
    }
}

// Create project
async function createProject(e) {
    e.preventDefault();

    if (!document.getElementById('projectName').value.trim() || !document.getElementById('clientSelect').value) {
        showToast('Заполните все обязательные поля', 'warning');
        return;
    }

    if (equipmentList.length === 0) {
        showToast('Добавьте оборудование в проект', 'warning');
        return;
    }

    const missingPeriods = equipmentList.some(item => !item.bookingPeriod);
    if (missingPeriods) {
        showToast('Укажите периоды бронирования для всего оборудования', 'warning');
        return;
    }

    // Get dates from date range picker
    const dateRange = $('#projectDates').data('daterangepicker');

    const projectData = {
        name: document.getElementById('projectName').value.trim(),
        client_id: parseInt(document.getElementById('clientSelect').value),
        description: document.getElementById('projectDescription').value.trim(),
        notes: document.getElementById('projectNotes').value.trim(),
        start_date: dateRange.startDate.format('YYYY-MM-DDTHH:mm:ss'),
        end_date: dateRange.endDate.format('YYYY-MM-DDTHH:mm:ss'),
        status: 'DRAFT',
        bookings: equipmentList.map(item => {
            const [startDate, endDate] = item.bookingPeriod.split(' - ');
            const equipmentId = parseInt(item.equipment_id);

            console.log('Преобразование ID оборудования:', {
                original: item.equipment_id,
                parsed: equipmentId,
                type: typeof equipmentId
            });

            if (isNaN(equipmentId)) {
                console.error('Некорректный ID оборудования:', item.equipment_id);
                throw new Error(`Некорректный ID оборудования: ${item.equipment_id}`);
            }

            return {
                equipment_id: equipmentId,
                start_date: moment(startDate, 'DD.MM.YYYY').format('YYYY-MM-DDTHH:mm:ss'),
                end_date: moment(endDate, 'DD.MM.YYYY').format('YYYY-MM-DDTHH:mm:ss')
            };
        })
    };

    console.log('Sending project data:', projectData);

    try {
        showLocalLoader();
        const response = await api.post('/projects/', projectData);
        console.log('Project created successfully:', response);
        window.location.href = '/projects/' + response.id;
    } catch (error) {
        console.error('Error creating project:', error);
        showToast('Ошибка создания проекта: ' + (error.message || 'Неизвестная ошибка'), 'danger');
        hideLocalLoader();
    }
}

// Apply project dates to all equipment
async function applyProjectDatesToAll() {
    if (!projectDateRange) {
        showToast('Сначала укажите период проекта', 'warning');
        return;
    }

    const formattedDateRange = projectDateRange.startDate.format('DD.MM.YYYY') + ' - ' + projectDateRange.endDate.format('DD.MM.YYYY');
    const startDate = projectDateRange.startDate.format('YYYY-MM-DD');
    const endDate = projectDateRange.endDate.format('YYYY-MM-DD');

    // Show local loader
    const applyButton = document.getElementById('applyProjectDatesBtn');
    const originalButtonText = applyButton.innerHTML;
    applyButton.disabled = true;
    applyButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Применение дат...';

    try {
        const equipmentIds = equipmentList.map(item => item.equipment_id);

        const availabilityChecks = await Promise.all(
            equipmentIds.map(id =>
                api.get(`/equipment/${id}/availability?start_date=${startDate}&end_date=${endDate}`)
            )
        );

        const conflictingEquipment = [];

        equipmentList.forEach((item, index) => {
            const availability = availabilityChecks[index];

            if (availability && availability.is_available) {
                item.bookingPeriod = formattedDateRange;
            } else {
                conflictingEquipment.push({
                    name: item.name,
                    barcode: item.barcode,
                    conflicts: availability?.conflicts || []
                });
            }
        });

        updateEquipmentUI();

        if (conflictingEquipment.length > 0) {
            let conflictMessage = `Не удалось установить даты для ${conflictingEquipment.length} единиц оборудования из-за конфликтов с существующими бронированиями:`;

            conflictingEquipment.forEach(item => {
                conflictMessage += `\n- ${item.name} (${item.barcode})`;
            });

            conflictMessage += "\n\nДаты были установлены только для доступного оборудования.";

            alert(conflictMessage);
        } else {
            showToast('Даты проекта применены ко всем позициям оборудования', 'success');
        }
    } catch (error) {
        console.error('Ошибка при проверке доступности оборудования:', error);
        showToast('Не удалось проверить доступность оборудования', 'danger');
    } finally {
        // Restore button state
        applyButton.disabled = false;
        applyButton.innerHTML = originalButtonText;
    }
}

// Check equipment availability
async function checkEquipmentAvailability(equipmentId, startDate, endDate) {
    try {
        showLocalLoader();
        const availability = await api.get(
            `/equipment/${equipmentId}/availability?start_date=${startDate}&end_date=${endDate}`
        );
        hideLocalLoader();

        if (availability.is_available) {
            return true;
        } else {
            let conflictMessage = 'Выбранный период недоступен для бронирования:';

            if (availability && availability.conflicts && availability.conflicts.length > 0) {
                availability.conflicts.forEach(conflict => {
                    const conflictStart = moment(conflict.start_date).format('DD.MM.YYYY');
                    const conflictEnd = moment(conflict.end_date).format('DD.MM.YYYY');
                    conflictMessage += `\n- Конфликт с бронированием: ${conflictStart} - ${conflictEnd}`;
                    if (conflict.project_name) {
                        conflictMessage += ` (Проект: ${conflict.project_name})`;
                    }
                });
            } else {
                conflictMessage += '\n- Оборудование недоступно в этот период';
            }

            conflictMessage += '\n\nПожалуйста, выберите другой период.';

            alert(conflictMessage);
            return false;
        }
    } catch (error) {
        hideLocalLoader();
        console.error('Ошибка при проверке доступности оборудования:', error);
        showToast('Не удалось проверить доступность оборудования', 'danger');
        return false;
    }
}
</script>
{% endblock %}
