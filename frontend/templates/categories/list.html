{% extends "base.html" %}

{% block title %}Категории - CINERENTAL{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Категории</h1>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
            <i class="fas fa-plus"></i> Добавить категорию
        </button>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Название</th>
                                    <th>Префикс</th>
                                    <th>Подкатегории</th>
                                    <th>Оборудование</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="categoriesTable">
                                <!-- Категории будут загружены динамически -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно добавления категории -->
<div class="modal fade" id="addCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Добавить категорию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addCategoryForm">
                    <div class="mb-3">
                        <label class="form-label">Название категории</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Префикс категории (2 символа, только буквы)</label>
                        <input type="text" class="form-control" name="prefix" required
                               maxlength="2" pattern="[A-Za-z]{2}"
                               title="Префикс должен содержать ровно 2 буквы">
                        <small class="form-text text-muted">
                            Префикс используется для генерации штрих-кодов. Например: CA для камер, LN для объективов.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="addCategory">Добавить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования категории -->
<div class="modal fade" id="editCategoryModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Редактировать категорию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCategoryForm">
                    <input type="hidden" name="id">
                    <div class="mb-3">
                        <label class="form-label">Название категории</label>
                        <input type="text" class="form-control" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Префикс категории (2 символа, только буквы)</label>
                        <input type="text" class="form-control" name="prefix" required
                               maxlength="2" pattern="[A-Za-z]{2}"
                               title="Префикс должен содержать ровно 2 буквы">
                        <small class="form-text text-muted">
                            Префикс используется для генерации штрих-кодов. Например: CA для камер, LN для объективов.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" id="updateCategory">Сохранить</button>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для управления подкатегориями -->
<div class="modal fade" id="subcategoriesModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Подкатегории - <span id="categoryName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <button class="btn btn-sm btn-primary" id="addSubcategoryBtn">
                        <i class="fas fa-plus"></i> Добавить подкатегорию
                    </button>
                </div>

                <div class="table-responsive">
                    <table class="table table-sm table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Название</th>
                                <th>Префикс</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody id="subcategoriesTable">
                            <!-- Подкатегории будут загружены динамически -->
                        </tbody>
                    </table>
                </div>

                <!-- Форма для добавления подкатегории -->
                <div id="addSubcategoryForm" class="border p-3 rounded mt-3" style="display: none;">
                    <h6>Добавить подкатегорию</h6>
                    <input type="hidden" id="subcategoryCategoryId">
                    <div class="mb-3">
                        <label class="form-label">Название</label>
                        <input type="text" class="form-control" id="subcategoryName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Префикс (2 символа, буквы или цифры)</label>
                        <input type="text" class="form-control" id="subcategoryPrefix" required
                               maxlength="2" pattern="[A-Za-z0-9]{2}"
                               title="Префикс должен содержать ровно 2 символа (буквы или цифры)">
                        <small class="form-text text-muted">
                            Префикс используется для генерации штрих-кодов.
                        </small>
                    </div>
                    <div>
                        <button type="button" class="btn btn-sm btn-primary" id="saveSubcategory">Сохранить</button>
                        <button type="button" class="btn btn-sm btn-secondary" id="cancelSubcategory">Отмена</button>
                    </div>
                </div>

                <!-- Форма для редактирования подкатегории -->
                <div id="editSubcategoryForm" class="border p-3 rounded mt-3" style="display: none;">
                    <h6>Редактировать подкатегорию</h6>
                    <input type="hidden" id="editSubcategoryId">
                    <div class="mb-3">
                        <label class="form-label">Название</label>
                        <input type="text" class="form-control" id="editSubcategoryName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Префикс (2 символа, буквы или цифры)</label>
                        <input type="text" class="form-control" id="editSubcategoryPrefix" required
                               maxlength="2" pattern="[A-Za-z0-9]{2}"
                               title="Префикс должен содержать ровно 2 символа (буквы или цифры)">
                    </div>
                    <div>
                        <button type="button" class="btn btn-sm btn-primary" id="updateSubcategory">Обновить</button>
                        <button type="button" class="btn btn-sm btn-secondary" id="cancelEditSubcategory">Отмена</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Загрузка категорий при загрузке страницы
    document.addEventListener('DOMContentLoaded', () => {
        loadCategories();
        setupEventListeners();
    });

    // Настройка обработчиков событий
    function setupEventListeners() {
        // Добавление категории
        document.getElementById('addCategory').addEventListener('click', addCategory);

        // Редактирование категории
        document.getElementById('updateCategory').addEventListener('click', updateCategory);

        // Добавление подкатегории
        document.getElementById('addSubcategoryBtn').addEventListener('click', () => {
            document.getElementById('addSubcategoryForm').style.display = 'block';
            document.getElementById('editSubcategoryForm').style.display = 'none';
        });

        document.getElementById('cancelSubcategory').addEventListener('click', () => {
            document.getElementById('addSubcategoryForm').style.display = 'none';
        });

        document.getElementById('saveSubcategory').addEventListener('click', addSubcategory);

        // Отмена редактирования подкатегории
        document.getElementById('cancelEditSubcategory').addEventListener('click', () => {
            document.getElementById('editSubcategoryForm').style.display = 'none';
        });

        // Обновление подкатегории
        document.getElementById('updateSubcategory').addEventListener('click', updateSubcategory);
    }

    // Загрузка категорий
    async function loadCategories() {
        try {
            showLoader();
            const categories = await api.get('/categories');
            const table = document.getElementById('categoriesTable');

            table.innerHTML = '';

            if (categories.length === 0) {
                table.innerHTML = '<tr><td colspan="6" class="text-center">Нет категорий</td></tr>';
                return;
            }

            categories.forEach(category => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${category.id}</td>
                    <td>${escapeHtml(category.name)}</td>
                    <td>${escapeHtml(category.prefix || '-')}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary subcategories-btn"
                                data-category-id="${category.id}"
                                data-category-name="${escapeHtml(category.name)}">
                            Подкатегории
                        </button>
                    </td>
                    <td>${category.equipment_count || 0}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-category"
                                data-category-id="${category.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });

            // Добавляем обработчики для редактирования и просмотра подкатегорий
            document.querySelectorAll('.edit-category').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const categoryId = e.target.closest('button').dataset.categoryId;
                    openEditCategoryModal(categoryId);
                });
            });

            document.querySelectorAll('.subcategories-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const categoryId = e.target.dataset.categoryId;
                    const categoryName = e.target.dataset.categoryName;
                    openSubcategoriesModal(categoryId, categoryName);
                });
            });
        } catch (error) {
            console.error('Ошибка при загрузке категорий:', error);
            showToast('Ошибка при загрузке категорий', 'danger');
        } finally {
            hideLoader();
        }
    }

    // Добавление категории
    async function addCategory() {
        const form = document.getElementById('addCategoryForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        // Валидация данных формы
        if (!data.name.trim()) {
            showToast('Необходимо указать название категории', 'warning');
            return;
        }

        if (!data.prefix || !data.prefix.match(/^[A-Za-z]{2}$/)) {
            showToast('Префикс должен содержать ровно 2 буквы', 'warning');
            return;
        }

        try {
            showLoader();
            await api.post('/categories/', data);
            showToast('Категория успешно добавлена', 'success');

            // Закрываем модальное окно и обновляем список категорий
            const modal = bootstrap.Modal.getInstance(document.getElementById('addCategoryModal'));
            modal.hide();
            form.reset();

            await loadCategories();
        } catch (error) {
            console.error('Ошибка при добавлении категории:', error);
            showToast('Ошибка при добавлении категории', 'danger');
        } finally {
            hideLoader();
        }
    }

    // Открытие модального окна редактирования категории
    async function openEditCategoryModal(categoryId) {
        try {
            showLoader();
            const category = await api.get(`/categories/${categoryId}`);

            const form = document.getElementById('editCategoryForm');
            form.elements.id.value = category.id;
            form.elements.name.value = category.name;
            form.elements.prefix.value = category.prefix || '';

            const modal = new bootstrap.Modal(document.getElementById('editCategoryModal'));
            modal.show();
        } catch (error) {
            console.error('Ошибка при загрузке категории:', error);
            showToast('Ошибка при загрузке категории', 'danger');
        } finally {
            hideLoader();
        }
    }

    // Обновление категории
    async function updateCategory() {
        const form = document.getElementById('editCategoryForm');
        const categoryId = form.elements.id.value;
        const data = {
            name: form.elements.name.value,
            prefix: form.elements.prefix.value
        };

        // Валидация данных формы
        if (!data.name.trim()) {
            showToast('Необходимо указать название категории', 'warning');
            return;
        }

        if (!data.prefix || !data.prefix.match(/^[A-Za-z]{2}$/)) {
            showToast('Префикс должен содержать ровно 2 буквы', 'warning');
            return;
        }

        try {
            showLoader();
            await api.put(`/categories/${categoryId}`, data);
            showToast('Категория успешно обновлена', 'success');

            // Закрываем модальное окно и обновляем список категорий
            const modal = bootstrap.Modal.getInstance(document.getElementById('editCategoryModal'));
            modal.hide();

            await loadCategories();
        } catch (error) {
            console.error('Ошибка при обновлении категории:', error);
            showToast('Ошибка при обновлении категории', 'danger');
        } finally {
            hideLoader();
        }
    }

    // Открытие модального окна подкатегорий
    async function openSubcategoriesModal(categoryId, categoryName) {
        try {
            showLoader();
            document.getElementById('categoryName').textContent = categoryName;
            document.getElementById('subcategoryCategoryId').value = categoryId;

            await loadSubcategories(categoryId);

            const modal = new bootstrap.Modal(document.getElementById('subcategoriesModal'));
            modal.show();
        } catch (error) {
            console.error('Ошибка при загрузке подкатегорий:', error);
            showToast('Ошибка при загрузке подкатегорий', 'danger');
        } finally {
            hideLoader();
        }
    }

    // Загрузка подкатегорий
    async function loadSubcategories(categoryId) {
        try {
            const subcategories = await api.get(`/categories/${categoryId}/subcategories`);
            const table = document.getElementById('subcategoriesTable');

            table.innerHTML = '';

            if (subcategories.length === 0) {
                table.innerHTML = '<tr><td colspan="4" class="text-center">Нет подкатегорий</td></tr>';
                return;
            }

            subcategories.forEach(subcategory => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${subcategory.id}</td>
                    <td>${escapeHtml(subcategory.name)}</td>
                    <td>${escapeHtml(subcategory.prefix)}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary edit-subcategory"
                                data-subcategory-id="${subcategory.id}">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-subcategory"
                                data-subcategory-id="${subcategory.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                table.appendChild(row);
            });

            // Добавляем обработчики для редактирования и удаления подкатегорий
            document.querySelectorAll('.edit-subcategory').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const subcategoryId = e.target.closest('button').dataset.subcategoryId;
                    openEditSubcategoryForm(subcategoryId);
                });
            });

            document.querySelectorAll('.delete-subcategory').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const subcategoryId = e.target.closest('button').dataset.subcategoryId;
                    deleteSubcategory(subcategoryId);
                });
            });
        } catch (error) {
            console.error('Ошибка при загрузке подкатегорий:', error);
            showToast('Ошибка при загрузке подкатегорий', 'danger');
        }
    }

    // Добавление подкатегории
    async function addSubcategory() {
        const categoryId = document.getElementById('subcategoryCategoryId').value;
        const name = document.getElementById('subcategoryName').value;
        const prefix = document.getElementById('subcategoryPrefix').value;

        // Валидация данных формы
        if (!name.trim()) {
            showToast('Необходимо указать название подкатегории', 'warning');
            return;
        }

        if (!prefix || !prefix.match(/^[A-Za-z0-9]{2}$/)) {
            showToast('Префикс должен содержать ровно 2 символа (буквы или цифры)', 'warning');
            return;
        }

        try {
            showLoader();
            await api.post(`/categories/${categoryId}/subcategories`, { name, prefix });
            showToast('Подкатегория успешно добавлена', 'success');

            // Сбрасываем форму и обновляем список подкатегорий
            document.getElementById('subcategoryName').value = '';
            document.getElementById('subcategoryPrefix').value = '';
            document.getElementById('addSubcategoryForm').style.display = 'none';

            await loadSubcategories(categoryId);
        } catch (error) {
            console.error('Ошибка при добавлении подкатегории:', error);
            showToast('Ошибка при добавлении подкатегории', 'danger');
        } finally {
            hideLoader();
        }
    }

    // Открытие формы редактирования подкатегории
    async function openEditSubcategoryForm(subcategoryId) {
        try {
            showLoader();
            const subcategory = await api.get(`/subcategories/${subcategoryId}`);

            document.getElementById('editSubcategoryId').value = subcategory.id;
            document.getElementById('editSubcategoryName').value = subcategory.name;
            document.getElementById('editSubcategoryPrefix').value = subcategory.prefix;

            document.getElementById('editSubcategoryForm').style.display = 'block';
            document.getElementById('addSubcategoryForm').style.display = 'none';
        } catch (error) {
            console.error('Ошибка при загрузке подкатегории:', error);
            showToast('Ошибка при загрузке подкатегории', 'danger');
        } finally {
            hideLoader();
        }
    }

    // Обновление подкатегории
    async function updateSubcategory() {
        const subcategoryId = document.getElementById('editSubcategoryId').value;
        const name = document.getElementById('editSubcategoryName').value;
        const prefix = document.getElementById('editSubcategoryPrefix').value;

        // Валидация данных формы
        if (!name.trim()) {
            showToast('Необходимо указать название подкатегории', 'warning');
            return;
        }

        if (!prefix || !prefix.match(/^[A-Za-z0-9]{2}$/)) {
            showToast('Префикс должен содержать ровно 2 символа (буквы или цифры)', 'warning');
            return;
        }

        try {
            showLoader();
            await api.put(`/subcategories/${subcategoryId}`, { name, prefix });
            showToast('Подкатегория успешно обновлена', 'success');

            // Сбрасываем форму и обновляем список подкатегорий
            document.getElementById('editSubcategoryForm').style.display = 'none';

            const categoryId = document.getElementById('subcategoryCategoryId').value;
            await loadSubcategories(categoryId);
        } catch (error) {
            console.error('Ошибка при обновлении подкатегории:', error);
            showToast('Ошибка при обновлении подкатегории', 'danger');
        } finally {
            hideLoader();
        }
    }

    // Удаление подкатегории
    async function deleteSubcategory(subcategoryId) {
        if (!confirm('Вы уверены, что хотите удалить эту подкатегорию?')) {
            return;
        }

        try {
            showLoader();
            await api.delete(`/subcategories/${subcategoryId}`);
            showToast('Подкатегория успешно удалена', 'success');

            const categoryId = document.getElementById('subcategoryCategoryId').value;
            await loadSubcategories(categoryId);
        } catch (error) {
            console.error('Ошибка при удалении подкатегории:', error);
            showToast('Ошибка при удалении подкатегории', 'danger');
        } finally {
            hideLoader();
        }
    }

    // Вспомогательная функция экранирования HTML
    function escapeHtml(str) {
        return String(str)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }
</script>
{% endblock %}
