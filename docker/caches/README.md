# Локальные зеркала для ускорения сборки Docker-образов

Этот документ описывает, как использовать локальные зеркала пакетов Python (PyPI) и Debian для значительного ускорения сборки Docker-образов.

## Преимущества использования локальных зеркал

1. **Скорость сборки**: Существенное ускорение сборки Docker-образов за счет кеширования зависимостей локально
2. **Экономия трафика**: Пакеты скачиваются только один раз
3. **Независимость от сети**: Меньшая зависимость от внешних источников и скорости интернет-соединения
4. **Воспроизводимость**: Гарантия наличия всех необходимых пакетов даже при проблемах с внешними репозиториями

## Настройка локальных зеркал

### Запуск зеркал с помощью Docker Compose

```bash
# Запуск всех кеш-серверов
docker compose -f docker-compose.caches.yml up -d

# Запуск только PyPI-кеша
docker compose -f docker-compose.caches.yml up -d pypi-cache

# Запуск только APT-кеша
docker compose -f docker-compose.caches.yml up -d apt-cacher
```

### Проверка работоспособности зеркал

После запуска кеш-серверов можно проверить их работоспособность:

1. **PyPI-кеш (devpi)**:
   ```bash
   curl http://localhost:3141
   ```

2. **APT-кеш (apt-cacher-ng)**:
   ```bash
   curl http://localhost:3142
   ```

## Использование локальных зеркал при сборке

### Автоматическая сборка с помощью скрипта

Для автоматического определения и использования доступных зеркал используйте скрипт:

```bash
# Сделать скрипт исполняемым (один раз)
chmod +x docker/build-test-image.sh

# Сборка с локальными зеркалами (если доступны)
./docker/build-test-image.sh local

# Принудительная сборка с удаленными репозиториями
./docker/build-test-image.sh remote
```

### Ручная сборка с указанием зеркал

Можно вручную указать адреса зеркал:

```bash
# Сборка с локальными зеркалами
PIP_INDEX_URL=http://localhost:3141/root/pypi/+simple/ \
PIP_TRUSTED_HOST=localhost \
APT_MIRROR=http://localhost:3142/debian \
docker compose -f docker-compose.test.yml build test
```

## Статистика и управление кешами

### Просмотр статистики apt-cacher-ng

Веб-интерфейс apt-cacher-ng доступен по адресу: http://localhost:3142/acng-report.html

### Управление devpi

Интерфейс devpi доступен по адресу: http://localhost:3141

### Очистка кешей

При необходимости можно очистить кеши:

```bash
# Удаление томов с данными
docker compose -f docker-compose.caches.yml down -v
```

## Решение проблем

### Если зеркала недоступны из Docker-контейнеров

1. Проверьте, что в файле `docker/build-test-image.sh` правильно определяется адрес Docker-хоста
2. Для Linux может потребоваться настройка маршрутизации или брандмауэра
3. На Windows и macOS проверьте, что Docker Desktop правильно настроен для доступа к хост-машине

### Если кеши не наполняются

1. Проверьте права доступа к томам Docker
2. Проверьте свободное место на диске
3. Проверьте логи сервисов: `docker compose -f docker-compose.caches.yml logs`
